import{o as f,c as g,a as c,r as at,w as Pt,v as kt,b as F,n as G,d as Lt,F as W,e as $,t as v,f as Dt,g as N,h as Ft,i as Nt}from"./vendor.e97305ba.js";import{C as st,r as Ut}from"./charts.e7add24e.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&a(n)}).observe(document,{childList:!0,subtree:!0});function i(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(r){if(r.ep)return;r.ep=!0;const o=i(r);fetch(r.href,o)}})();function Gt(){const t=console.error;console.error=function(...e){const i=e.length>0?String(e[0]):"";["ResizeObserver loop limit exceeded","Non-passive event listener","Chart.js"].some(o=>i.includes(o))||t.apply(console,e)},window.addEventListener("error",e=>{console.error("Global error:",e.error)}),window.addEventListener("unhandledrejection",e=>{console.error("Unhandled promise rejection:",e.reason)})}st.register(...Ut);const U={chartInstances:{},updatesEnabled:!0,registerChart(t,e){this.chartInstances[t]=e},unregisterChart(t){this.chartInstances[t]&&delete this.chartInstances[t]},getChart(t){return this.chartInstances[t]},canUpdate(){return this.updatesEnabled},pauseUpdates(){this.updatesEnabled=!1},resumeUpdates(){this.updatesEnabled=!0},safeUpdateChart(t){if(!this.canUpdate())return!1;const e=this.getChart(t);if(!e)return!1;try{return e.update("none"),!0}catch(i){return console.warn(`Error updating chart ${t}:`,i.message),!1}},resetAllCharts(){for(const t in this.chartInstances)try{const e=this.chartInstances[t];e&&e.data&&e.data.datasets&&(e.data.datasets.forEach(i=>{Array.isArray(i.data)&&(t.toLowerCase().includes("temperature")?i.data.fill(null):i.data.fill(0))}),e.update("none"))}catch(e){console.warn(`Error resetting chart ${t}:`,e.message)}return!0},optimizeMemoryUsage(){for(const t in this.chartInstances){const e=this.chartInstances[t];if(e&&e.data&&e.data.datasets){e.data.datasets.forEach(i=>{i.pointRadius=0}),e.options.animation=!1;try{e.update("none")}catch(i){console.warn(`Failed to optimize chart ${t}:`,i)}}}}};const tt=(t,e)=>{const i=t.__vccOpts||t;for(const[a,r]of e)i[a]=r;return i},Wt={props:{title:{type:String,required:!0},currentTemperature:{type:Number,required:!0},setPoint:{type:Number,required:!0},timeStep:{type:Number,default:0},history:{type:Array,default:()=>[]}},data(){return{chart:null,temperatureData:[],maxDataPoints:96,isChartInitialized:!1,pendingUpdate:!1,chartOptions:null}},mounted(){this.$nextTick(()=>{this.initChart()})},methods:{initChart(){try{if(!this.$refs.chartCanvas){console.log("Canvas not found for",this.title),setTimeout(()=>this.initChart(),100);return}const t=this.$refs.chartCanvas.getContext("2d");if(!t){console.error("Failed to get canvas context");return}if(this.temperatureData=new Array(this.maxDataPoints).fill(null),this.history&&this.history.length>0)for(let i=0;i<Math.min(this.history.length,this.maxDataPoints);i++)this.temperatureData[i]=this.history[i];this.timeStep>=0&&this.timeStep<this.maxDataPoints&&(this.temperatureData[this.timeStep]=this.currentTemperature),this.chart&&(U.unregisterChart(this.title),this.chart.destroy(),this.chart=null);const e={type:"line",data:{labels:Array.from({length:this.maxDataPoints},(i,a)=>a),datasets:[{label:"Current Temperature",data:[...this.temperatureData],borderColor:this.title.includes("Home")?"#3b82f6":"#10b981",backgroundColor:this.title.includes("Home")?"#3b82f6":"#10b981",tension:.4,fill:!1,pointRadius:0,segment:{borderColor:i=>i.p0.parsed.x<=this.timeStep?this.title.includes("Home")?"#3b82f6":"#10b981":this.title.includes("Home")?"rgba(59, 130, 246, 0.3)":"rgba(16, 185, 129, 0.3)"}},{label:"Set Point",data:new Array(this.maxDataPoints).fill(this.setPoint),borderColor:"#ff7300",borderDash:[5,5],borderWidth:2,pointRadius:0,fill:!1}]},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,plugins:{title:{display:!0,text:this.title,font:{size:16,weight:"bold"}},tooltip:{mode:"index",intersect:!1,callbacks:{label:function(i){return i.parsed.y!==null?`${i.dataset.label}: ${i.parsed.y.toFixed(1)}°C`:null}}},legend:{display:!0,position:"top"}},scales:{x:{title:{display:!0,text:"Time Step"},grid:{display:!1},ticks:{callback:function(i){return i%24===0?i:""}}},y:{title:{display:!0,text:"Temperature (°C)"},grid:{display:!1},min:this.title.includes("Home")?18:55,max:this.title.includes("Home")?25:65}}}};this.chart=new st(t,e),U.registerChart(this.title,this.chart),this.isChartInitialized=!0,this.pendingUpdate&&(this.updateChart(),this.pendingUpdate=!1)}catch(t){console.error(`Error initializing chart (${this.title}):`,t.message),this.isChartInitialized=!1,setTimeout(()=>this.initChart(),500)}},updateChart(){if(!this.chart||!this.isChartInitialized){this.pendingUpdate=!0;return}try{if(this.timeStep>=0&&this.timeStep<this.maxDataPoints){const t=[...this.temperatureData];if(t[this.timeStep]=this.currentTemperature,this.temperatureData=t,this.chart.data&&this.chart.data.datasets){this.chart.data.datasets[0].data=[...this.temperatureData];const e=[],i=[],a=[],r=this.title.includes("Home")?"#3b82f6":"#10b981",o=this.title.includes("Home")?"rgba(59, 130, 246, 0.3)":"rgba(16, 185, 129, 0.3)";for(let n=0;n<this.maxDataPoints;n++)n<=this.timeStep?(e.push(r),i.push(r)):(e.push(o),i.push(o)),a.push(n===this.timeStep?4:0);this.chart.data.datasets[0].pointBackgroundColor=e,this.chart.data.datasets[0].pointBorderColor=i,this.chart.data.datasets[0].pointRadius=a,this.chart.data.datasets[0].segment={borderColor:n=>n.p0.parsed.x<=this.timeStep?r:o}}this.chart.update("none")}}catch(t){console.warn(`Error updating chart (${this.title}):`,t.message)}},updateFromHistory(){if(!this.chart||!this.isChartInitialized){this.pendingUpdate=!0;return}try{const t=[...this.temperatureData];if(this.history&&this.history.length>0)for(let e=0;e<Math.min(this.history.length,this.maxDataPoints);e++)this.history[e]!==null&&this.history[e]!==void 0&&(t[e]=this.history[e]);this.timeStep>=0&&this.timeStep<this.maxDataPoints&&(t[this.timeStep]=this.currentTemperature),this.temperatureData=t,this.chart.data&&this.chart.data.datasets&&(this.chart.data.datasets[0].data=[...this.temperatureData]),U.safeUpdateChart(this.title)}catch(t){console.warn(`Error updating chart from history (${this.title}):`,t.message)}},resetChartData(){if(!(!this.chart||!this.isChartInitialized))try{this.temperatureData=new Array(this.maxDataPoints).fill(null),this.chart.data&&this.chart.data.datasets&&this.chart.data.datasets.length>0&&(this.chart.data.datasets[0].data=[...this.temperatureData],this.chart.data.datasets[1].data=new Array(this.maxDataPoints).fill(this.setPoint),this.chart.update("none"))}catch(t){console.warn("Error resetting chart data:",t.message)}}},watch:{currentTemperature(){this.updateChart()},timeStep(t){t===0&&this.currentTemperature!==void 0&&this.temperatureData.every(i=>i===null)&&this.resetChartData(),this.updateChart()},setPoint(){if(this.chart&&this.chart.data&&this.chart.data.datasets&&this.chart.data.datasets.length>1)try{this.chart.data.datasets[1].data=new Array(this.maxDataPoints).fill(this.setPoint),this.chart.update("none")}catch(t){console.error(`Error updating setpoint (${this.title}):`,t)}},history:{handler(t){t&&Array.isArray(t)&&t.length>0&&this.updateFromHistory()},deep:!1},title(){this.isChartInitialized=!1,this.$nextTick(()=>{this.initChart()})}},beforeUnmount(){this.chart&&(U.unregisterChart(this.title),this.chart.destroy(),this.chart=null,this.isChartInitialized=!1)}},$t={class:"temperature-chart"},Bt={ref:"chartCanvas",width:"600",height:"250"};function zt(t,e,i,a,r,o){return f(),g("div",$t,[c("canvas",Bt,null,512)])}const Vt=tt(Wt,[["render",zt],["__scopeId","data-v-3f0fd73c"]]);const Yt={props:{shiftableAppliances:{type:Object,required:!0},timeStep:{type:Number,default:0},powerHistory:{type:Object,default:()=>({})}},data(){return{chart:null,maxDataPoints:96,isChartInitialized:!1,pendingUpdate:!1,isUpdating:!1,lastUpdateTimeStep:null,dataCache:{},applianceColors:{dishwasher:{border:"#ef4444",background:"rgba(239, 68, 68, 0.2)"},wash_machine:{border:"#8b5cf6",background:"rgba(139, 92, 246, 0.2)"},clothes_dryer:{border:"#f59e0b",background:"rgba(245, 158, 11, 0.2)"}}}},mounted(){this.$nextTick(()=>{this.initChart()})},methods:{getApplianceTimepoints(){const t=new Set([0,95]);this.timeStep>=0&&this.timeStep<this.maxDataPoints&&t.add(this.timeStep);for(const e in this.powerHistory){const i=this.powerHistory[e];if(i){if(!Array.isArray(i)){console.warn(`Power history for ${e} is not an array:`,i);continue}if(i.length!==0)for(let a=1;a<i.length;a++){const r=i[a-1]||0,o=i[a]||0;(r===0&&o>0||r>0&&o===0)&&t.add(a)}}}return Array.from(t).sort((e,i)=>e-i)},initChart(){try{if(!this.$refs.chartCanvas){setTimeout(()=>this.initChart(),100);return}const t=this.$refs.chartCanvas.getContext("2d");if(!t){console.error("Failed to get canvas context");return}this.dataCache={};const e=[];for(const a in this.shiftableAppliances){const r=this.shiftableAppliances[a],o=this.formatApplianceName(a);let n,l;if(this.applianceColors[a])n=this.applianceColors[a].border,l=this.getTransparentColor(n,.1);else switch(a){case"dishwasher":n="#ef4444",l="rgba(239, 68, 68, 0.1)";break;case"wash_machine":n="#8b5cf6",l="rgba(139, 92, 246, 0.1)";break;case"clothes_dryer":n="#f59e0b",l="rgba(245, 158, 11, 0.1)";break;default:n="#3b82f6",l="rgba(59, 130, 246, 0.1)"}const s=new Array(this.maxDataPoints).fill(0);if(this.powerHistory[a])for(let h=0;h<Math.min(this.powerHistory[a].length,this.maxDataPoints);h++)s[h]=this.powerHistory[a][h]||0;this.timeStep>=0&&this.timeStep<this.maxDataPoints&&(s[this.timeStep]=r.active?r.power:0),this.dataCache[a]=[...s],e.push({label:o,data:[...s],borderColor:n,borderWidth:2,backgroundColor:l,steppedLine:!0,stepped:"before",tension:0,fill:!0,pointRadius:0,segment:{borderColor:h=>h.p0.parsed.x<=this.timeStep?n:this.getFadedColor(n,.3),backgroundColor:h=>h.p0.parsed.x<=this.timeStep?l:this.getFadedColor(n,.05)}})}this.chart&&(U.unregisterChart("appliance-power"),this.chart.destroy(),this.chart=null);const i=[0,24,48,72,95];this.chart=new st(t,{type:"line",data:{labels:Array.from({length:this.maxDataPoints},(a,r)=>r),datasets:e},options:{responsive:!0,maintainAspectRatio:!1,animation:!1,elements:{line:{stepped:!0}},plugins:{title:{display:!0,text:"Appliance Power Consumption",font:{size:16,weight:"bold"}},tooltip:{mode:"index",intersect:!1,callbacks:{label:function(a){return a.parsed.y!==null?`${a.dataset.label}: ${a.parsed.y.toFixed(1)} kW`:null}}},legend:{position:"top"}},scales:{x:{title:{display:!0,text:"Time Step"},grid:{display:!1},ticks:{callback:function(a){return i.includes(a)?a:""}}},y:{stacked:!1,title:{display:!0,text:"Power (kW)"},grid:{display:!1},beginAtZero:!0}}}}),U.registerChart("appliance-power",this.chart),this.isChartInitialized=!0,this.pendingUpdate&&(this.updateChart(),this.pendingUpdate=!1)}catch(t){console.error("Error initializing appliance power chart:",t.message),this.isChartInitialized=!1,setTimeout(()=>{this.initChart()},1e3)}},getTransparentColor(t,e){if(t.startsWith("rgba"))return t.replace(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*[\d.]+\)/,`rgba($1, $2, $3, ${e})`);if(t.startsWith("#")){const i=parseInt(t.slice(1,3),16),a=parseInt(t.slice(3,5),16),r=parseInt(t.slice(5,7),16);return`rgba(${i}, ${a}, ${r}, ${e})`}return`rgba(59, 130, 246, ${e})`},updateChart(){if(!this.chart||!this.isChartInitialized){this.pendingUpdate=!0;return}try{if(this.isUpdating)return;if(this.isUpdating=!0,!this.shiftableAppliances){this.isUpdating=!1;return}let t=0;for(const e in this.shiftableAppliances){const i=this.shiftableAppliances[e];if(this.timeStep>=0&&this.timeStep<this.maxDataPoints){const a=i.active?i.power:0;if(e==="clothes_dryer"&&this.shiftableAppliances.wash_machine){const r=this.shiftableAppliances.wash_machine;r.progress<r.total_duration&&(a=0)}if(this.dataCache[e]||(this.dataCache[e]=new Array(this.maxDataPoints).fill(0)),this.dataCache[e][this.timeStep]!==a){const r=[...this.dataCache[e]];if(r[this.timeStep]=a,this.dataCache[e]=r,this.chart.data&&this.chart.data.datasets&&t<this.chart.data.datasets.length&&(this.chart.data.datasets[t].data[this.timeStep]=a,!this.lastUpdateTimeStep||this.lastUpdateTimeStep!==this.timeStep)){const o=this.getBorderColorForAppliance(e),n=this.getBackgroundColorForAppliance(e,.2),l=this.getBackgroundColorForAppliance(e,.05);this.chart.data.datasets[t].segment={borderColor:s=>s.p0.parsed.x<=this.timeStep?o:this.getFadedColor(o,.3),backgroundColor:s=>s.p0.parsed.x<=this.timeStep?n:l}}}t++}}this.lastUpdateTimeStep!==this.timeStep&&(this.chart.update("none"),this.lastUpdateTimeStep=this.timeStep),this.isUpdating=!1}catch(t){this.isUpdating=!1,console.warn("Error updating appliance chart:",t.message)}},getBorderColorForAppliance(t){switch(t){case"dishwasher":return"#ef4444";case"wash_machine":return"#8b5cf6";case"clothes_dryer":return"#f59e0b";default:return"#3b82f6"}},getBackgroundColorForAppliance(t,e){const i=this.getBorderColorForAppliance(t);return this.getTransparentColor(i,e)},getFadedColor(t,e){return this.getTransparentColor(t,e)},updateFromHistory(){if(!this.chart||!this.isChartInitialized){this.pendingUpdate=!0;return}if(!this.isUpdating){this.isUpdating=!0;try{if(!this.powerHistory)return;let t=!1;for(let e=0;e<this.chart.data.datasets.length;e++){const i=Object.keys(this.powerHistory);if(e<i.length){const a=i[e];if(!this.chart.data.datasets[e])continue;if(this.powerHistory[a])for(let r=0;r<Math.min(this.powerHistory[a].length,this.maxDataPoints);r++){const o=this.powerHistory[a][r]||0;if(a==="clothes_dryer"&&this.powerHistory.wash_machine){let n=!1;for(let l=0;l<=r;l++)if(this.powerHistory.wash_machine[l]>0){n=!0;break}n||(o=0)}(!this.dataCache[a]||this.dataCache[a][r]!==o)&&(this.dataCache[a]||(this.dataCache[a]=new Array(this.maxDataPoints).fill(0)),this.dataCache[a][r]=o,this.chart.data.datasets[e].data[r]=o,t=!0)}}}t&&U.safeUpdateChart("appliance-power")}finally{this.isUpdating=!1}}},formatApplianceName(t){return t.replace(/_/g," ").replace(/([A-Z])/g," $1").replace(/^./,e=>e.toUpperCase())}},watch:{shiftableAppliances:{handler(){if(!this.isUpdating){this.isUpdating=!0;try{if(this.chart&&this.chart.data&&this.chart.data.datasets&&this.timeStep>=0&&this.timeStep<this.maxDataPoints){let t=!1;for(let e=0;e<this.chart.data.datasets.length;e++){const i=Object.keys(this.shiftableAppliances);if(e<i.length){const a=i[e],r=this.shiftableAppliances[a],o=r.active?r.power:0;(!this.dataCache[a]||this.dataCache[a][this.timeStep]!==o)&&(t=!0,this.dataCache[a]||(this.dataCache[a]=new Array(this.maxDataPoints).fill(0)),this.dataCache[a][this.timeStep]=o,this.chart.data.datasets[e].data[this.timeStep]=o)}}t&&this.chart.update("none")}else this.isChartInitialized||(this.pendingUpdate=!0)}finally{this.isUpdating=!1}}},deep:!0},timeStep(){this.updateChart()},powerHistory:{handler(){this.powerHistory&&typeof this.powerHistory=="object"&&Object.keys(this.powerHistory).length>0&&this.updateFromHistory()},deep:!1}},beforeUnmount(){this.chart&&(U.unregisterChart("appliance-power"),this.chart.destroy(),this.chart=null,this.isChartInitialized=!1)}},Xt={class:"appliance-power-chart"},Kt={ref:"chartCanvas",width:"600",height:"250"};function qt(t,e,i,a,r,o){return f(),g("div",Xt,[c("canvas",Kt,null,512)])}const jt=tt(Yt,[["render",qt],["__scopeId","data-v-65608d38"]]);async function Jt(t){try{const e=await fetch(t);if(!e.ok)throw new Error(`Failed to load configuration file: ${e.statusText}`);return await e.json()}catch(e){throw console.error("Error loading configuration:",e),e}}function Zt(t){return!t||!t.appliances?[]:t.appliances.map(e=>({id:e.id,name:e.name,power:e.defaultPower,active:e.active||!1,icon:e.icon||null,type:e.type,powerType:e.powerType,group:e.group||3,connections:Array.isArray(e.connections)?e.connections.map(i=>typeof i=="string"?i:String(i)):[],minPower:e.minPower,maxPower:e.maxPower,schedule:e.schedule||[],runDuration:e.runDuration}))}function Qt(t){if(!t||!t.powerSources)return{solar:{capacity:5,efficiency:.85},battery:{capacity:13.5,initialLevel:50},grid:{maxPower:10,exportEnabled:!0}};const e={};return t.powerSources.forEach(i=>{i.connections&&(i.connections=i.connections.map(a=>typeof a=="string"?a:String(a))),e[i.id]={...i}}),e}function te(t){return!t||!Array.isArray(t)?[]:t.map(e=>({hour:e.hour||"00:00",hourValue:e.hourValue||0,solar:isFinite(e.solar)?Math.min(Math.max(parseFloat(e.solar)||0,0),6):0,temperature:isFinite(e.temperature)?Math.min(Math.max(parseFloat(e.temperature)||20,-10),40):20,price:isFinite(e.price)?Math.min(Math.max(parseFloat(e.price)||.01,0),.5):.01,raw:e.raw||[]}))}async function ee(t=null){try{let e=null;if(!e)try{const p=await fetch("/hourly.csv");p.ok&&(e=await p.text())}catch(p){console.log("Fetch attempt failed:",p)}if(!e&&window.fs&&typeof window.fs.readFile=="function")try{e=await window.fs.readFile("hourly.csv",{encoding:"utf8"})}catch(p){console.log("File system read attempt failed:",p)}if(!e)throw new Error("No sample data found for hourly simulation!");console.log("Successfully loaded hourly data");const i=e.split(`
`).filter(p=>p.trim()),a=i[0].split(",").map(p=>p.trim().replace(/^["']|["']$/g,"")),r=a.indexOf("Hour"),o=a.indexOf("Solar"),n=a.indexOf("T_out"),l=a.indexOf("RTP");if(r===-1||o===-1||n===-1||l===-1)throw new Error(`Required columns not found in CSV. Found: ${a.join(", ")}`);const s=[];for(let p=24;p<i.length;p++){if(!i[p].trim())continue;const u=i[p].split(",").map(I=>I.trim());let d=parseInt(u[r]||"0");const m=Math.floor(d/100),T=`${m.toString().padStart(2,"0")}:00`,C=parseFloat(u[o]||"0"),_=parseFloat((C/1e3*5).toFixed(1)),H=parseFloat(parseFloat(u[n]||"0").toFixed(1)),L=parseFloat(parseFloat(u[l]||"0").toFixed(3));s.push({hour:T,hourValue:m,solar:_,temperature:H,price:L,raw:u})}const h=te(s);return{success:!0,data:h,hourlyData:h,length:h.length}}catch(e){return console.error("Error reading hourly data:",e),{success:!1,error:e.message,data:[],hourlyData:[],length:0}}}const A={COP_COOLING:3.5,COP_HEATING:2.5,BUILDING_FACTOR:.15,THERMAL_MASS:5,INSULATION_FACTOR:8,SETPOINT_COOLING:20,SETPOINT_HEATING:19,COMFORT_RANGE:2,MAX_POWER_COOLING:2,MAX_POWER_HEATING:2,TIME_STEP:.25};function Mt(t,e,i){if(!i){const m=(e-t)*(A.TIME_STEP/A.INSULATION_FACTOR);return{power:0,nextIndoorTemp:t+m}}const a=e>A.SETPOINT_COOLING,r=a?A.SETPOINT_COOLING:A.SETPOINT_HEATING,o=a?A.COP_COOLING:A.COP_HEATING,n=a?A.MAX_POWER_COOLING:A.MAX_POWER_HEATING,l=t-r;let s=A.BUILDING_FACTOR*Math.abs(l);a&&l<0||!a&&l>0?s=s*.5:(a&&l>A.COMFORT_RANGE||!a&&l<-A.COMFORT_RANGE)&&(s=s*1.5),s=Math.min(s,n);const h=s*o;let p=h/A.THERMAL_MASS*A.TIME_STEP;a&&(p=-p);const u=(e-t)*(A.TIME_STEP/A.INSULATION_FACTOR),d=t+p+u;return{power:s,nextIndoorTemp:d,effectivePower:h,isCooling:a,temperatureChange:p,naturalDrift:u}}function ie(t){return(t>A.SETPOINT_COOLING?A.SETPOINT_COOLING:A.SETPOINT_HEATING)*.7+t*.3}const w={SPECIFIC_HEAT:4.186,DENSITY:1,TANK_VOLUME:200,TANK_INSULATION_FACTOR:.05,EFFICIENCY:.92,MAX_POWER:4.5,SETPOINT:60,COMFORT_RANGE:3,COLD_WATER_TEMP:15,AMBIENT_TEMP:22,TIME_STEP:.25,WATER_USAGE:{MORNING_PEAK:.1,EVENING_PEAK:.08,MIDDAY:.03,BACKGROUND:.01}};function re(t){const e=parseInt(t.split(":")[0]);return e>=6&&e<=9?w.WATER_USAGE.MORNING_PEAK:e>=18&&e<=22?w.WATER_USAGE.EVENING_PEAK:e>=11&&e<=14?w.WATER_USAGE.MIDDAY:w.WATER_USAGE.BACKGROUND}function it(t,e,i){const a=re(i);if(!e){const d=w.TANK_INSULATION_FACTOR*(t-w.AMBIENT_TEMP)*w.TIME_STEP,m=(w.COLD_WATER_TEMP-t)*a;return{power:0,nextWaterTemp:t-d+m,waterUsage:a,heatLoss:d,waterReplacement:m}}const r=w.SETPOINT-t;if(r<=0){const d=w.TANK_INSULATION_FACTOR*(t-w.AMBIENT_TEMP)*w.TIME_STEP,m=(w.COLD_WATER_TEMP-t)*a;return{power:0,nextWaterTemp:t-d+m,waterUsage:a,heatLoss:d,waterReplacement:m}}let n=w.SPECIFIC_HEAT*w.DENSITY*w.TANK_VOLUME*r/3600/w.TIME_STEP/w.EFFICIENCY;n=Math.min(n,w.MAX_POWER);const s=n*w.EFFICIENCY*w.TIME_STEP*3600/(w.SPECIFIC_HEAT*w.DENSITY*w.TANK_VOLUME),h=w.TANK_INSULATION_FACTOR*(t-w.AMBIENT_TEMP)*w.TIME_STEP,p=(w.COLD_WATER_TEMP-t)*a,u=t+s-h+p;return{power:n,nextWaterTemp:u,temperatureIncrease:s,waterUsage:a,heatLoss:h,waterReplacement:p}}function ae(t){const e=parseInt(t.split(":")[0]);return e>=9&&e<=11?w.SETPOINT-8:e>=22||e<=1?w.SETPOINT-6:w.SETPOINT-2}const S={BATTERY_CAPACITY:60,MIN_SOC:.1,MAX_SOC:.95,INITIAL_SOC_RANGE:[.3,.4],MAX_POWER_LEVEL_1:1.9,MAX_POWER_LEVEL_2:7,MAX_POWER_LEVEL_2_HIGH:11.5,CHARGING_EFFICIENCY:.9,LOW_PRICE_THRESHOLD:.025,HIGH_PRICE_THRESHOLD:.045,TIME_STEP:.25,DEPARTURE_HOUR:7,ARRIVAL_HOUR:18,TARGET_SOC:.85};function Z(t){const e=parseInt(t.split(":")[0]);return e>=S.ARRIVAL_HOUR||e<S.DEPARTURE_HOUR}function Rt(t){const e=parseInt(t.split(":")[0]);return e<S.DEPARTURE_HOUR?S.DEPARTURE_HOUR-e:24-e+S.DEPARTURE_HOUR}function se(){const[t,e]=S.INITIAL_SOC_RANGE;return t+Math.random()*(e-t)}function rt(t,e,i,a,r){if(!e||!i)return{power:0,nextSoC:t,isConnected:e,hoursToDepart:e?Rt(a):null};const o=Rt(a),n=t*S.BATTERY_CAPACITY;let h=(S.TARGET_SOC*S.BATTERY_CAPACITY-n)/o;if(h<.1)return{power:0,nextSoC:t,isConnected:!0,hoursToDepart:o,alreadyCharged:!0};let p;if(r<=S.LOW_PRICE_THRESHOLD)p=S.MAX_POWER_LEVEL_2;else if(r>=S.HIGH_PRICE_THRESHOLD)p=h/S.CHARGING_EFFICIENCY;else{const _=S.HIGH_PRICE_THRESHOLD-S.LOW_PRICE_THRESHOLD,H=(r-S.LOW_PRICE_THRESHOLD)/_;p=S.MAX_POWER_LEVEL_2-H*(S.MAX_POWER_LEVEL_2-h/S.CHARGING_EFFICIENCY)}let u=Math.min(p,S.MAX_POWER_LEVEL_2);const d=(S.MAX_SOC-t)*S.BATTERY_CAPACITY/S.TIME_STEP;u=Math.min(u,d),u=Math.max(0,u);const m=u*S.CHARGING_EFFICIENCY*S.TIME_STEP,T=t+m/S.BATTERY_CAPACITY,C=Math.min(T,S.MAX_SOC);return{power:u,nextSoC:C,isConnected:!0,hoursToDepart:o,energyTransferred:m,batteryAcceptanceLimit:d,requiredPower:h}}const Ht={DISHWASHER:{START_RANGE:[68,77],END_RANGE:[86,95],DURATION:3,GROUP:1},WASH_MACHINE:{START_RANGE:[36,48],END_RANGE:[60,72],DURATION:6,GROUP:1},CLOTHES_DRYER:{START_RANGE:null,END_RANGE:null,DURATION:5,GROUP:1},TV:{START_RANGE:[72,80],DURATION_RANGE:[12,20],GROUP:3},REFRIGERATOR:{START_RANGE:[0,0],DURATION_RANGE:[95,95],GROUP:3},LIGHTS:{START_RANGE:[68,72],DURATION_RANGE:[16,24],GROUP:3},VACUUM:{START_RANGE:[52,62],DURATION_RANGE:[1,6],GROUP:3},HAIR_DRYER:{START_RANGE:[76,86],DURATION_RANGE:[1,1],GROUP:3}};function q(t){if(!t||!Array.isArray(t)||t.length!==2)throw new Error("Invalid range: Must be an array with two elements [min, max]");const[e,i]=t;return e===i?e:Math.floor(Math.random()*(i-e+1))+e}function oe(){const t={};let e=0;for(const[i,a]of Object.entries(Ht))if(i!=="CLOTHES_DRYER"){if(a.GROUP===1){const r=q(a.START_RANGE),n=q(a.END_RANGE)-a.DURATION;if(n<r){console.warn(`Invalid schedule for ${i}: deadline too early for duration`);continue}const l=q([r,n]),s=l+a.DURATION;t[Q(i)]={startTime:l,endTime:s},i==="WASH_MACHINE"&&(e=s)}if(a.GROUP===3){const r=q(a.START_RANGE);let o=a.DURATION_RANGE?q(a.DURATION_RANGE):a.DURATION;const n=r+o;t[Q(i)]={startTime:r,endTime:n}}}if(e>0){const i=Ht.CLOTHES_DRYER,a=e,r=a+i.DURATION;t[Q("CLOTHES_DRYER")]={startTime:a,endTime:r}}else console.warn("Clothes dryer not initialized!"),t[Q("CLOTHES_DRYER")]={startTime:60,endTime:68};return t}function Q(t){return{DISHWASHER:"dishwasher",WASH_MACHINE:"wash_machine",CLOTHES_DRYER:"clothes_dryer",TV:"tv",REFRIGERATOR:"refrigerator",LIGHTS:"lights",VACUUM:"vacuum",HAIR_DRYER:"hair_dryer"}[t]||t.toLowerCase()}const ne={components:{TemperatureChart:Vt,AppliancePowerChart:jt},props:{solarOutput:{type:Number,default:0},batteryLevel:{type:Number,default:35},batteryStatus:{type:String,default:"empty"},batteryPower:{type:Number,default:0},gridPower:{type:Number,default:0},houseDemand:{type:Number,default:0},appliances:{type:Array,default:()=>[]},isRunning:{type:Boolean,default:!1},simulationState:{type:String,default:"idle"},simulationCompleted:{type:Boolean,default:!1},rlPrediction:{type:Object,default:()=>null},simulationElapsedMinutes:{type:Number,default:0},simulationFormattedTime:{type:String,default:"00:00"},simulationDay:{type:Number,default:1}},data(){return{animationSpeed:2,simulationInterval:null,simulationHours:1,speedOptions:[{value:1,label:"Slow",interval:1e3},{value:2,label:"Medium",interval:300},{value:3,label:"Fast",interval:100}],selectedSpeed:1,customIcons:{},activeTab:"appliances",editableConfig:null,powerSources:[],connections:[],activeConnections:[],simulatorAppliances:[],simulationTime:"00:00",localSimulationDay:1,elapsedMinutes:0,hourlyData:[],hourlyDataLoaded:!1,simulationSteps:0,energyModels:{indoorTemperature:24,waterTemperature:55,evSoC:0,evConnected:!1,hvacHistory:[],waterHeaterHistory:[],evHistory:[]},applianceStartTimes:{dishwasher:-1,wash_machine:-1,clothes_dryer:-1},sourcesLayout:{solar:{x:100,y:90},battery:{x:500,y:120},grid:{x:900,y:90},house:{x:500,y:280}},defaultConnections:this.getDefaultConnections(),homeTemperatureHistory:new Array(96).fill(null),waterTemperatureHistory:new Array(96).fill(null),appliancePowerHistory:{dishwasher:new Array(96).fill(0),wash_machine:new Array(96).fill(0),clothes_dryer:new Array(96).fill(0)},waterHeaterConstants:{setPoint:60,comfortRange:2},resetCounter:0,chartData:{solar:{primary:Array(96).fill(null),battery:Array(96).fill(null)},temperature:{primary:Array(96).fill(null),indoor:Array(96).fill(null),water:Array(96).fill(null)},price:{primary:Array(96).fill(null)}},charts:{solar:null,temperature:null,price:null},currentHourData:{hour:"00:00",solar:0,temperature:20,price:.01},lastUpdatedStep:-1,chartUpdateInterval:null,applianceSchedules:null,aiScheduleDownloaded:!1}},computed:{formattedSimulationTime(){return this.simulationTime},powerData(){return{solarOutput:this.solarOutput,batteryLevel:this.batteryLevel,batteryStatus:this.batteryStatus,gridPower:this.gridPower,houseDemand:this.houseDemand}},energyStats(){const t=[{type:"solar",title:"Solar Production",value:`${this.solarOutput} kW`},{type:"battery",title:"Battery Level",value:`${this.batteryLevel.toFixed(1)}%`},{type:"grid",title:"Grid Usage",value:`${this.gridPower} kW`},{type:"home",title:"Home Demand",value:`${this.houseDemand} kW`}];return this.energyModels&&this.energyModels.evConnected&&t.push({type:"ev",title:"EV Charge",value:`${Math.round(this.energyModels.evSoC*100)}%`}),t},rlStats(){return this.rlPrediction?[{id:"time",title:"Current Time",value:`Day ${this.safeGet(this.rlPrediction,"day",1)}, ${this.formatTime(this.safeGet(this.rlPrediction,"timestamp","00:00"))}`},{id:"price",title:"Grid Price",value:`$${this.safeGet(this.rlPrediction,"environment.price",.003).toFixed(3)}/kWh`},{id:"demand",title:"Total Demand",value:`${this.safeGet(this.rlPrediction,"energy_flow.house.demand.total",-.1).toFixed(1)} kW`},{id:"grid-flow",title:"Grid Import/Export",value:`${Math.abs(this.safeGet(this.rlPrediction,"energy_flow.grid.net_power",0)).toFixed(1)} kW ${this.safeGet(this.rlPrediction,"energy_flow.grid.net_power",0)<0?"Export":"Import"}`,class:this.safeGet(this.rlPrediction,"energy_flow.grid.net_power",0)<0?"export":""}]:[]}},async created(){await this.loadDefaultConfig(),await this.loadHourlyData(),this.hourlyDataLoaded&&this.$nextTick(()=>this.initCharts())},methods:{getGroupTitle(t){return{1:"Fixed Power Appliances (Run Full Duration)",2:"Variable Power Appliances",3:"Fixed Power Appliances (Toggle Anytime)"}[t]||"Unknown Group"},getGroupColor(t){return{1:"#be123c",2:"#047857",3:"#1d4ed8"}[t]||"#000000"},getChartTitle(t){return{solar:"Solar & Battery (kW)",temperature:"Temperature (°C)",price:"Electricity Price ($/kWh)"}[t]||t},formatChartValue(t,e){if(e==null)return"N/A";switch(t){case"solar":return`${e} kW`;case"temperature":return`${e}°C`;case"price":return`$${e}/kWh`;default:return e}},updateBatteryHistory(t,e){var a,r,o;const i=t%96;if(this.batteryHistory||(this.batteryHistory=Array(96).fill(null),this.batteryHistory[0]=this.batteryLevel),this.batteryHistory[i]=e,(r=(a=this.chartData)==null?void 0:a.solar)!=null&&r.battery){this.chartData.solar.battery[0]===null&&(this.chartData.solar.battery[0]=this.batteryLevel),this.chartData.solar.battery[i]=e;let n=0;for(let l=1;l<i;l++)this.chartData.solar.battery[l]!==null&&(n=l);if(n<i-1&&n>0){const l=this.chartData.solar.battery[n],s=i-n,h=(e-l)/s;for(let p=1;p<s;p++){const u=n+p;this.chartData.solar.battery[u]===null&&(this.chartData.solar.battery[u]=l+h*p)}}(o=this.charts)!=null&&o.solar&&this.charts.solar.updateSeries([{name:"Solar",data:this.chartData.solar.primary},{name:"Battery",data:this.chartData.solar.battery}])}},cleanupCharts(){["solar","airTemp","waterTemp","price"].forEach(e=>{if(this.charts[e]){try{this.charts[e].destroy()}catch(i){console.warn(`Error destroying ${e} chart:`,i)}this.charts[e]=null}})},initSolarChart(t,e,i){const a={series:[{name:"Solar",data:this.chartData.solar.primary},{name:"Battery",data:this.chartData.solar.battery}],chart:{height:160,type:"line",animations:{enabled:!1},toolbar:{show:!1},zoom:{enabled:!1},fontFamily:"Arial, sans-serif",background:"#ffffff",redrawOnWindowResize:!1},colors:["#f59e0b","#10b981"],stroke:{curve:"smooth",width:[3,3],lineCap:"round",dashArray:[0,0]},markers:{size:0,hover:{size:4,sizeOffset:2}},xaxis:{categories:e,tickPlacement:"on",min:0,max:95,labels:{formatter:r=>i[r]||""}},yaxis:[{min:0,max:6,tickAmount:6,title:{text:"Solar Output (kW)"},labels:{formatter:r=>r==null?"":r.toFixed(1)}},{min:0,max:100,tickAmount:5,opposite:!0,title:{text:"Battery Level (%)"},labels:{formatter:r=>r==null?"":`${r.toFixed(0)}%`}}],tooltip:{enabled:!0,shared:!0,x:{formatter:r=>{const o=Math.floor(r*15/60),n=r*15%60;return`${o.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`}},y:{formatter:function(r,{seriesIndex:o}){return o===0?r==null?"N/A":`${r.toFixed(1)} kW`:r==null?"N/A":`${r.toFixed(0)}%`}}},dataLabels:{enabled:!1},grid:{show:!1},legend:{show:!0}};this.charts.solar=new window.ApexCharts(t,a),this.charts.solar.render()},initAirTempChart(t,e,i){const a={series:[{name:"Outdoor",data:this.chartData.temperature.primary},{name:"Indoor",data:this.chartData.temperature.indoor}],chart:{height:160,type:"line",animations:{enabled:!1},toolbar:{show:!1},zoom:{enabled:!1},fontFamily:"Arial, sans-serif",background:"#ffffff",redrawOnWindowResize:!1},colors:["#ef4444","#3b82f6"],stroke:{curve:"smooth",width:[2,3],lineCap:"round",dashArray:[0,0]},markers:{size:0,hover:{size:4,sizeOffset:2}},xaxis:{categories:e,tickPlacement:"on",min:0,max:95,labels:{formatter:r=>i[r]||""}},yaxis:{min:0,max:30,tickAmount:5,title:{text:"Air Temperature (°C)"},labels:{formatter:r=>r==null||isNaN(r)?"":r.toFixed(1)}},tooltip:{enabled:!0,shared:!0,x:{formatter:r=>{const o=Math.floor(r*15/60),n=r*15%60;return`${o.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`}},y:{formatter:r=>r==null?"N/A":`${r.toFixed(1)} °C`}},dataLabels:{enabled:!1},grid:{show:!1},legend:{show:!0},annotations:{yaxis:[{y:20,borderColor:"rgba(4, 120, 87, 0.4)",borderWidth:2,borderDash:[5,5],label:{position:"left",offsetX:-5,style:{fontSize:"10px",color:"#047857",background:"#f8fafc"}}}]}};this.charts.airTemp=new window.ApexCharts(t,a),this.charts.airTemp.render()},initWaterTempChart(t,e,i){!this.chartData.temperature.water[0]&&this.energyModels.waterTemperature&&(this.chartData.temperature.water[0]=this.energyModels.waterTemperature);const a={series:[{name:"Water",data:this.chartData.temperature.water}],chart:{height:160,type:"line",animations:{enabled:!1},toolbar:{show:!1},zoom:{enabled:!1},fontFamily:"Arial, sans-serif",background:"#ffffff",redrawOnWindowResize:!1},colors:["#f59e0b"],stroke:{curve:"smooth",width:3,lineCap:"round"},markers:{size:0,hover:{size:4,sizeOffset:2}},xaxis:{categories:e,tickPlacement:"on",min:0,max:95,labels:{formatter:r=>i[r]||""}},yaxis:{min:40,max:70,tickAmount:5,title:{text:"Water Temperature (°C)"},labels:{formatter:r=>r==null||isNaN(r)?"":r.toFixed(1)}},tooltip:{enabled:!0,shared:!0,x:{formatter:r=>{const o=Math.floor(r*15/60),n=r*15%60;return`${o.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`}},y:{formatter:r=>r==null?"N/A":`${r.toFixed(1)} °C`}},dataLabels:{enabled:!1},grid:{show:!1},legend:{show:!0},annotations:{yaxis:[{y:60,borderColor:"rgba(245, 158, 11, 0.4)",borderWidth:2,borderDash:[5,5],label:{position:"left",offsetX:-5,style:{fontSize:"10px",color:"#f59e0b",background:"#f8fafc"}}}]}};this.charts.waterTemp=new window.ApexCharts(t,a),this.charts.waterTemp.render()},initPriceChart(t,e,i){this.chartData.price.primary||(this.chartData.price.primary=Array(96).fill(null)),this.chartData.price.energy||(this.chartData.price.energy=Array(96).fill(0)),[...this.chartData.price.primary],[...this.chartData.price.energy];const a={series:[{name:"Energy (kWh)",type:"column",data:this.chartData.price.energy},{name:"Price",type:"line",data:this.chartData.price.primary}],chart:{height:160,type:"line",animations:{enabled:!1},toolbar:{show:!1},zoom:{enabled:!1},fontFamily:"Arial, sans-serif",background:"#ffffff",redrawOnWindowResize:!1,stacked:!1},colors:["#64748b","#8b5cf6"],stroke:{curve:"smooth",width:[0,3],lineCap:"round"},fill:{opacity:[.6,1]},plotOptions:{column:{borderRadius:2,columnWidth:"60%"}},markers:{size:[0,4],hover:{size:4,sizeOffset:2}},xaxis:{categories:e,tickPlacement:"on",min:0,max:95,labels:{formatter:r=>i[r]||""}},yaxis:[{seriesName:"Energy (kWh)",min:0,max:3,tickAmount:3,title:{text:"Energy (kWh)"},labels:{formatter:r=>r.toFixed(1)}},{seriesName:"Price",opposite:!0,min:0,max:.1,tickAmount:5,title:{text:"Price ($/kWh)"},labels:{formatter:r=>r==null||isNaN(r)?"":"$"+r.toFixed(3)}}],tooltip:{enabled:!0,shared:!0,x:{formatter:r=>{const o=Math.floor(r*15/60),n=r*15%60;return`${o.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`}},y:{formatter:(r,{seriesIndex:o})=>o===0?r==null?"N/A":`${r.toFixed(2)} kWh`:r==null?"N/A":`$${r.toFixed(3)}/kWh`}},dataLabels:{enabled:!1},grid:{show:!1},legend:{show:!0}};this.charts.price=new window.ApexCharts(t,a),this.charts.price.render()},initCharts(){if(this.chartData||(this.chartData={solar:{primary:Array(96).fill(null),battery:Array(96).fill(null)},temperature:{primary:Array(96).fill(null),indoor:Array(96).fill(null),water:Array(96).fill(null)},price:{primary:Array(96).fill(null),energy:Array(96).fill(0)}},this.batteryHistory=Array(96).fill(null),this.batteryHistory[0]=this.batteryLevel,this.chartData.solar.battery[0]=this.batteryLevel,this.chartData.temperature.indoor[0]=this.energyModels.indoorTemperature,this.chartData.temperature.water[0]=this.energyModels.waterTemperature),typeof window.ApexCharts>"u"){console.error("ApexCharts not available");return}const t=[document.getElementById("solar-chart-container"),document.getElementById("air-temp-chart-container"),document.getElementById("water-temp-chart-container"),document.getElementById("price-chart-container")];if(t.some(e=>!e)){setTimeout(()=>this.initCharts(),100);return}this.cleanupCharts();try{const e=Array(96).fill(0).map((a,r)=>r),i={0:"0",16:"4",32:"8",48:"12",64:"16",80:"20"};this.initSolarChart(t[0],e,i),this.initAirTempChart(t[1],e,i),this.initWaterTempChart(t[2],e,i),this.initPriceChart(t[3],e,i),console.log("Charts initialized successfully")}catch(e){console.error("Error initializing charts:",e)}},updateChartMarkers(t,e,i){try{const a=[];for(let r=0;r<t.w.config.series.length;r++)a.push({seriesIndex:r,dataPointIndex:e,size:4,strokeColor:i[r]||i[0],fillColor:"#ffffff"});t.updateOptions({markers:{discrete:a}},!1,!1)}catch(a){console.warn("Error updating chart markers:",a)}},updateChartDataPoint(t,e,i,a=null,r=null,o=null){if(this.charts[t]){this.chartData[t]&&(this.chartData[t].primary[e]=i),t==="solar"&&a!==null?(this.chartData[t].battery[e]=a,this.charts.solar&&this.charts.solar.updateSeries([{name:"Solar",data:this.chartData[t].primary},{name:"Battery",data:this.chartData[t].battery}],!1,!1)):t==="temperature"?(a!==null&&(this.chartData[t].indoor[e]=a),r!==null&&(this.chartData[t].water[e]=r),this.charts.airTemp&&this.charts.airTemp.updateSeries([{name:"Outdoor",data:this.chartData[t].primary},{name:"Indoor",data:this.chartData[t].indoor}],!1,!1),this.charts.waterTemp&&this.charts.waterTemp.updateSeries([{name:"Water",data:this.chartData[t].water}],!1,!1)):t==="price"&&(o!==null&&(this.chartData[t].energy||(this.chartData[t].energy=Array(96).fill(0)),this.chartData[t].energy[e]=o),this.charts.price&&this.charts.price.updateSeries([{name:"Energy (kWh)",type:"column",data:this.chartData[t].energy},{name:"Price",type:"line",data:this.chartData[t].primary}],!1,!1));try{e%4===0&&(t==="solar"&&this.charts.solar?this.updateChartMarkers(this.charts.solar,e,["#f59e0b","#10b981"]):t==="temperature"?(this.charts.airTemp&&this.updateChartMarkers(this.charts.airTemp,e,["#ef4444","#3b82f6"]),this.charts.waterTemp&&this.updateChartMarkers(this.charts.waterTemp,e,["#f59e0b"])):t==="price"&&this.charts.price&&this.updateChartMarkers(this.charts.price,e,["#8b5cf6"]))}catch(n){console.warn(`Error updating ${t} chart:`,n)}}},updateCharts(t){var s,h;if(!this.hourlyDataLoaded||!this.isRunning)return;if(!(this.charts.solar&&this.charts.airTemp&&this.charts.waterTemp&&this.charts.price)){this.initCharts();return}const i=this.batteryLevel,a=this.energyModels.indoorTemperature,r=this.energyModels.waterTemperature,o=this.gridPower;if(t===this.lastUpdatedStep)return;this.lastUpdatedStep=t;const n=Math.floor(t/4)%(((s=this.hourlyData)==null?void 0:s.length)||1),l=(h=this.hourlyData)==null?void 0:h[n];l&&(this.currentHourData={hour:l.hour||"99:99",solar:l.solar||0,temperature:l.temperature||99,price:l.price||-.001},this.updateSolarChart(t,l.solar,i),this.updateTemperatureCharts(t,l.temperature,a,r),this.updatePriceChart(t,l.price,o),this.updateBatteryHistory(t,i),t%20===0&&this.optimizeChartPerformance())},updateSolarChart(t,e,i){const a=Math.floor(t/4)*4;for(let r=0;r<4;r++){const o=(a+r)%96;o===t%96?this.updateChartDataPoint("solar",o,e,i):this.updateChartDataPoint("solar",o,e)}},updateTemperatureCharts(t,e,i,a){const r=Math.floor(t/4)*4;for(let o=0;o<4;o++){const n=(r+o)%96;this.chartData.temperature.primary[n]=e,i!=null&&(this.chartData.temperature.indoor[n]=i),a!=null&&(this.chartData.temperature.water[n]=a)}this.charts.airTemp&&(this.charts.airTemp.updateSeries([{name:"Outdoor",data:this.chartData.temperature.primary},{name:"Indoor",data:this.chartData.temperature.indoor}],!1,!1),t%4===0&&this.updateChartMarkers(this.charts.airTemp,t,["#ef4444","#3b82f6"])),this.charts.waterTemp&&(this.charts.waterTemp.updateSeries([{name:"Water",data:this.chartData.temperature.water}],!1,!1),t%4===0&&this.updateChartMarkers(this.charts.waterTemp,t,["#f59e0b"]))},updatePriceChart(t,e,i=0){const a=Math.max(0,i*.25);this.chartData.price.energy||(this.chartData.price.energy=Array(96).fill(0)),this.chartData.price.energy[t]=a,this.chartData.price.primary||(this.chartData.price.primary=Array(96).fill(null)),this.chartData.price.primary[t]=e,this.charts.price&&this.charts.price.updateSeries([{name:"Energy (kWh)",type:"column",data:[...this.chartData.price.energy]},{name:"Price",type:"line",data:[...this.chartData.price.primary]}],!1,!1)},optimizeChartPerformance(){if(this.simulationSteps>95){const t=this.simulationSteps%96,e=Math.max(0,t-20),i=Math.min(95,t+20);for(let a=0;a<96;a++)(a<e||a>i)&&a%4!==0&&this.chartData.price.energy&&(this.chartData.price.energy[a]=0)}this.charts.price&&this.charts.price.updateOptions({chart:{animations:{enabled:!1}}})},formatTime(t){if(t==null)return"00:00";const e=t*15,i=Math.floor(e/60),a=e%60;return`${i.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`},formatAppName(t){return t.replace(/_/g," ").replace(/([A-Z])/g," $1").replace(/^./,e=>e.toUpperCase())},getIconSvg(t){const e={solar:`<g>
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </g>`,battery:`<g>
          <rect x="1" y="6" width="18" height="12" rx="2" ry="2"></rect>
          <line x1="23" y1="13" x2="23" y2="11"></line>
        </g>`,grid:'<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>',house:`<g>
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </g>`};return e[t]||e.house},getApplianceSvg(t){const e={hvac:`<g>
          <rect x="2" y="3" width="20" height="18" rx="2" ry="2"></rect>
          <line x1="7" y1="3" x2="7" y2="21"></line>
          <line x1="17" y1="3" x2="17" y2="21"></line>
          <line x1="2" y1="9" x2="22" y2="9"></line>
          <line x1="2" y1="15" x2="22" y2="15"></line>
        </g>`,refrigerator:`<g>
          <rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect>
          <path d="M4 13h16"></path>
          <path d="M8 2v2"></path>
          <path d="M8 13v2"></path>
        </g>`,lights:`<g>
          <circle cx="12" cy="12" r="5"></circle>
          <path d="M12 1v2M12 21v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"></path>
        </g>`,ev_charger:`<g>
          <rect x="6" y="11" width="12" height="10" rx="2" ry="2"></rect>
          <path d="M12 2v9"></path>
          <path d="M9 5h6"></path>
          <path d="M9 16h6"></path>
        </g>`,dishwasher:`<g>
          <rect x="2" y="4" width="20" height="16" rx="2" ry="2"></rect>
          <path d="M6 4v16"></path>
          <path d="M18 4v16"></path>
          <path d="M2 10h4"></path>
          <path d="M2 14h4"></path>
          <path d="M18 10h4"></path>
          <path d="M18 14h4"></path>
        </g>`,water_heater:`<g>
          <rect x="6" y="3" width="12" height="18" rx="2" ry="2"></rect>
          <path d="M12 7v10"></path>
          <path d="M10 13h4"></path>
        </g>`,wash_machine:`<g>
          <rect x="2" y="2" width="20" height="20" rx="2" ry="2"></rect>
          <circle cx="12" cy="12" r="6"></circle>
          <circle cx="12" cy="12" r="2"></circle>
        </g>`,clothes_dryer:`<g>
          <rect x="2" y="2" width="20" height="20" rx="2" ry="2"></rect>
          <circle cx="12" cy="12" r="6"></circle>
          <line x1="12" y1="6" x2="12" y2="18"></line>
          <line x1="6" y1="12" x2="18" y2="12"></line>
        </g>`,tv:`<g>
          <rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect>
          <polyline points="17 2 12 7 7 2"></polyline>
        </g>`,vacuum:`<g>
          <circle cx="12" cy="12" r="9"></circle>
          <path d="M7 15h10"></path>
          <path d="M12 6v6"></path>
         </g>`,hair_dryer:`<g>
          <path d="M10 6h4v14a2 2 0 01-2 2 2 2 0 01-2-2V6z"></path>
          <path d="M6 6h8a0 0 0 011 1v3a0 0 0 01-1 1H6a2 2 0 01-2-2V8a2 2 0 012-2z"></path>
          <path d="M18 4v6"></path>
          <path d="M18 6l-4-2"></path>
          <path d="M18 8l-4 2"></path>
        </g>`};return e[t]||e.hvac},getApplianceIcon(t){return this.customIcons[t]?{type:"image",path:this.customIcons[t]}:{type:"component",component:t}},onSpeedChange(){const t=this.speedOptions.find(i=>i.value===this.selectedSpeed);this.updateAnimationSpeed(t.value);const e=t.value*30;this.$emit("speed-changed",{animationSpeed:t.value,interval:t.interval,timeScale:e}),this.selectedSpeed===3&&U.optimizeMemoryUsage()},updateAnimationSpeed(t){const e=1/t;document.documentElement.style.setProperty("--animation-duration",`${e}s`),document.querySelectorAll(".flow-right, .flow-left, .flow-down, .flow-up").forEach(a=>{a.style.setProperty("--animation-duration",`${e}s`)})},async loadDefaultConfig(){try{const t=await Jt("/appliances-config.json");this.initializeFromConfig(t)}catch(t){console.error("Error loading default configuration:",t)}},initializeFromConfig(t){this.editableConfig=JSON.parse(JSON.stringify(t)),this.simulatorAppliances=Zt(t);const e=Qt(t);this.initializePowerSources(e),this.initializeConnections()},initializePowerSources(t){var e,i,a,r,o,n,l,s,h;this.powerSources=[{id:"solar",name:((e=t.solar)==null?void 0:e.name)||"Solar Panel",type:"solar",capacity:((i=t.solar)==null?void 0:i.capacity)||5,efficiency:((a=t.solar)==null?void 0:a.efficiency)||.85,active:this.solarOutput>0,x:this.sourcesLayout.solar.x,y:this.sourcesLayout.solar.y,rectX:-40,rectY:-40,width:80,height:80,rx:5,iconX:-20,iconY:-20,iconWidth:40,iconHeight:40,labelX:0,labelY:60,valueX:0,valueY:80,customIcon:null,bgFill:"#fff9e6",stroke:"#f59e0b",displayValue:`${this.solarOutput} kW`},{id:"battery",name:((r=t.battery)==null?void 0:r.name)||"Battery",type:"battery",capacity:((o=t.battery)==null?void 0:o.capacity)||6.4,active:this.batteryStatus!=="empty",x:this.sourcesLayout.battery.x,y:this.sourcesLayout.battery.y,rectX:-40,rectY:-40,width:80,height:80,rx:5,iconX:-20,iconY:-20,iconWidth:40,iconHeight:40,labelX:0,labelY:60,valueX:0,valueY:80,customIcon:null,bgFill:"#f0fdf4",stroke:"#10b981",displayValue:`${this.batteryLevel.toFixed(1)}%`},{id:"grid",name:((n=t.grid)==null?void 0:n.name)||"Power Grid",type:"grid",maxPower:((l=t.grid)==null?void 0:l.maxPower)||10,exportEnabled:((s=t.grid)==null?void 0:s.exportEnabled)||!0,active:this.gridPower>0,x:this.sourcesLayout.grid.x,y:this.sourcesLayout.grid.y,rectX:-40,rectY:-40,width:80,height:80,rx:5,iconX:-20,iconY:-20,iconWidth:40,iconHeight:40,labelX:0,labelY:60,valueX:0,valueY:80,customIcon:null,bgFill:"#f5f3ff",stroke:"#8b5cf6",displayValue:`${this.gridPower} kW`},{id:"house",name:((h=t.house)==null?void 0:h.name)||"Home",type:"house",active:!0,x:this.sourcesLayout.house.x,y:this.sourcesLayout.house.y,rectX:-60,rectY:-60,width:120,height:120,rx:5,iconX:-30,iconY:-30,iconWidth:60,iconHeight:60,labelX:0,labelY:80,valueX:0,valueY:100,customIcon:null,bgFill:"#eff6ff",stroke:"#3b82f6",displayValue:`${this.houseDemand} kW`}]},getDefaultConnections(){return[{from:"solar",to:"battery",x1:140,y1:90,x2:460,y2:120,direction:"right",color:"#f59e0b"},{from:"solar",to:"house",x1:140,y1:90,x2:450,y2:230,direction:"right",color:"#f59e0b"},{from:"solar",to:"grid",x1:140,y1:60,x2:860,y2:60,direction:"right",color:"#f59e0b"},{from:"battery",to:"house",x1:500,y1:120,x2:500,y2:230,direction:"down",color:"#10b981"},{from:"grid",to:"house",x1:860,y1:90,x2:560,y2:230,direction:"right",color:"#8b5cf6"},{from:"grid",to:"battery",x1:860,y1:90,x2:540,y2:120,direction:"right",color:"#8b5cf6"}]},initializeConnections(){this.connections=this.defaultConnections.map(t=>({...t,active:!1,strokeWidth:2,powerFlow:0,labelX:(t.x1+t.x2)/2,labelY:(t.y1+t.y2)/2-10})),this.updateConnectionsStatus()},updateConnectionsStatus(){this.validateAppliancePower(),this.connections.forEach(u=>{u.active=!1,u.powerFlow=0,u.strokeWidth=2});const t=this.recalculateHouseDemand();Math.abs(t-this.houseDemand)>.1&&this.$emit("demand-updated",t);const e=10.01,i=.099,a=t;let r=0;if(this.solarOutput>i&&a>i){const u=Math.min(this.solarOutput,a);u>i&&this.activateConnection("solar","house",u)}const o=Math.max(0,a-Math.min(this.solarOutput,a));let n=0;const l=e+(this.batteryLevel<e+5?5:0);this.batteryStatus==="discharging"&&this.batteryPower<0&&this.batteryLevel>l&&o>i&&(n=Math.min(o,Math.abs(this.batteryPower)),n>i&&this.activateConnection("battery","house",n));const s=Math.max(0,o-n);s>i&&(this.activateConnection("grid","house",s),r+=s);const h=Math.max(0,this.solarOutput-Math.min(this.solarOutput,a));if(h>i&&this.batteryStatus==="charging"&&this.batteryLevel<100&&this.batteryPower>0){const u=Math.min(h,this.batteryPower);u>i&&this.activateConnection("solar","battery",u)}const p=Math.max(0,h-(this.batteryStatus==="charging"?Math.min(h,this.batteryPower):0));if(p>i&&this.activateConnection("solar","grid",p),this.batteryStatus==="charging"&&this.batteryPower>0&&h<i){const u=this.batteryPower;u>i&&(this.activateConnection("grid","battery",u),r+=u)}Math.abs(r-this.gridPower)>.1&&this.$emit("grid-power-updated",parseFloat(r.toFixed(1))),this.activeConnections=[...this.connections],this.batteryLevel<=e&&this.batteryStatus==="discharging"&&this.$emit("battery-critical")},activateConnection(t,e,i){const a=this.connections.find(r=>r.from===t&&r.to===e);a&&(a.active=!0,a.powerFlow=parseFloat(i.toFixed(1)),a.strokeWidth=Math.max(2,Math.min(8,i*1.5)))},validateAppliancePower(){let t=!1;const e=this.simulatorAppliances.map(i=>{if(i.active&&(i.power===0||isNaN(parseFloat(i.power)))){t=!0;const a=i.defaultPower||this.getDefaultPowerForType(i.type);return{...i,power:a}}return i});return t&&(this.simulatorAppliances=e,this.recalculateHouseDemand()),t},getDefaultPowerForType(t){return{dishwasher:1.8,wash_machine:.4,clothes_dryer:1.2,hvac:2.5,water_heater:4.5,ev_charger:6,tv:.1,refrigerator:.2,lights:.2,vacuum:1.2,hair_dryer:1}[t]||1},updatePowerSourcesFromProps(){const t=this.powerSources.find(r=>r.id==="solar");t&&(t.active=this.solarOutput>0,t.displayValue=`${this.solarOutput} kW`);const e=this.powerSources.find(r=>r.id==="battery");e&&(e.active=this.batteryStatus!=="empty",e.displayValue=`${this.batteryLevel.toFixed(1)}%`);const i=this.powerSources.find(r=>r.id==="grid");i&&(i.active=this.gridPower>0,i.displayValue=`${this.gridPower} kW`);const a=this.powerSources.find(r=>r.id==="house");a&&(a.displayValue=`${this.houseDemand} kW`)},startSimulation(){this.simulationSteps=0,this.elapsedMinutes=0,this.localSimulationDay=1,this.simulationTime="00:00",this.lastUpdatedStep=-1;const t=this.simulationHours?this.simulationHours*3600:null;let e=null;this.hourlyDataLoaded&&this.hourlyData.length>0&&(e=this.hourlyData.length*4),this.$nextTick(()=>{this.hourlyDataLoaded&&!this.charts.solar&&this.initCharts()}),this.$emit("start-simulation",{timeLimit:t,maxSteps:e}),this.chartUpdateTimer=setInterval(()=>{if(this.isRunning&&this.hourlyDataLoaded){const i=this.simulationSteps%96;this.updateCharts(i)}},1e3)},pauseSimulation(){this.chartUpdateTimer&&(clearInterval(this.chartUpdateTimer),this.chartUpdateTimer=null),this.$emit("pause-simulation")},resumeSimulation(){this.$emit("resume-simulation")},resetSimulation(){this.chartUpdateTimer&&(clearInterval(this.chartUpdateTimer),this.chartUpdateTimer=null),this.simulationSteps=0,this.simulationTime="00:00",this.localSimulationDay=1,this.elapsedMinutes=0,this.lastUpdatedStep=-1,this.resetCharts(),this.resetCounter++,this.updateConnectionsStatus(),this.$emit("solar-output-updated",0),this.$emit("battery-level-updated",35),this.$emit("battery-status-updated","empty"),this.$emit("grid-power-updated",0),this.$emit("demand-updated",this.recalculateHouseDemand()),this.applianceStartTimes={dishwasher:-1,wash_machine:-1,clothes_dryer:-1},this.aiScheduleDownloaded=!1,this.$emit("reset-simulation"),U.optimizeMemoryUsage()},toggleApplianceStatus(t){const e=this.simulatorAppliances.findIndex(i=>i.id===t);if(e!==-1){const a=!this.simulatorAppliances[e].active,r={...this.simulatorAppliances[e],active:a};this.simulatorAppliances=[...this.simulatorAppliances.slice(0,e),r,...this.simulatorAppliances.slice(e+1)];const o=parseFloat(this.simulatorAppliances.filter(n=>n.active).reduce((n,l)=>n+(parseFloat(l.power)||0),0).toFixed(1));this.$emit("demand-updated",o),this.$emit("toggle-appliance",t)}else console.warn(`Appliance with id ${t} not found`);this.updateConnectionsStatus()},loadConfigFile(){this.$refs.configFileInput&&this.$refs.configFileInput.click()},onConfigFileSelected(t){const e=t.target.files[0];if(!e)return;const i=new FileReader;i.onload=a=>{try{const r=JSON.parse(a.target.result);if(!r.appliances||!r.powerSources)throw new Error("Invalid configuration format: missing appliances or powerSources");this.initializeFromConfig(r)}catch(r){console.error("Error parsing configuration file:",r),alert("Invalid configuration file format. Please upload a valid JSON file.")}},i.readAsText(e)},safeGet(t,e,i=null){try{return e.split(".").reduce((a,r)=>a&&a[r]!==void 0?a[r]:i,t)}catch{return i}},updateHistoryData(){if(!this.rlPrediction)return;console.log("==== Appliance Scheduling Logic ===="),console.log("Washer Status:",this.rlPrediction.appliances.shiftable.wash_machine),console.log("Dryer Status:",this.rlPrediction.appliances.shiftable.clothes_dryer);const t=this.rlPrediction.appliances.shiftable.wash_machine.progress>=this.rlPrediction.appliances.shiftable.wash_machine.total_duration;console.log("Washing Complete:",t),console.log("Current Time Step:",this.rlPrediction.timestamp);try{const e=this.safeGet(this.rlPrediction,"timestamp",0);if(e>=0&&e<96){const i=this.safeGet(this.rlPrediction,"temperatures.home.current",null);if(i!==null){const r=[...this.homeTemperatureHistory];r[e]=i,this.homeTemperatureHistory=r}const a=this.safeGet(this.rlPrediction,"temperatures.water.current",null);if(a!==null){const r=[...this.waterTemperatureHistory];r[e]=a,this.waterTemperatureHistory=r}if(this.rlPrediction.appliances&&this.rlPrediction.appliances.shiftable){const r=JSON.parse(JSON.stringify(this.appliancePowerHistory)),o={dishwasher:3,wash_machine:6,clothes_dryer:5},n={dishwasher:1.8,wash_machine:.4,clothes_dryer:1.2};this.applianceStartTimes||(this.applianceStartTimes={dishwasher:-1,wash_machine:-1,clothes_dryer:-1});const l=this.rlPrediction.appliances.shiftable.wash_machine,s=l&&l.progress>=l.total_duration;for(const h in this.rlPrediction.appliances.shiftable){r[h]||(r[h]=new Array(96).fill(0));const p=this.rlPrediction.appliances.shiftable[h];if(p){const u=o[h];let d=0;if(p.active&&this.applianceStartTimes[h]===-1&&(h!=="clothes_dryer"?this.applianceStartTimes[h]=e:s&&(this.applianceStartTimes[h]=e)),this.applianceStartTimes[h]!==-1){const m=e-this.applianceStartTimes[h];m>=0&&m<u?(d=n[h],r[h][e]=d):r[h][e]=0}else r[h][e]=0}}this.appliancePowerHistory=r}this.$emit("history-updated",{timeStep:e,homeTemp:i,waterTemp:a})}}catch(e){console.error("Error in updateHistoryData:",e)}},resetCharts(){for(const t in this.charts)this.charts[t]&&(this.charts[t].destroy(),this.charts[t]=null);this.chartData={solar:{primary:Array(96).fill(null),battery:Array(96).fill(null)},temperature:{primary:Array(96).fill(null),indoor:Array(96).fill(null),water:Array(96).fill(null)},price:{primary:Array(96).fill(null),energy:Array(96).fill(0)}},this.$nextTick(()=>{this.hourlyDataLoaded&&this.initCharts()}),this.homeTemperatureHistory=Array(96).fill(null),this.waterTemperatureHistory=Array(96).fill(null),this.appliancePowerHistory={dishwasher:Array(96).fill(0),wash_machine:Array(96).fill(0),clothes_dryer:Array(96).fill(0)}},async loadHourlyData(){try{const t=await ee();return t.success&&t.hourlyData&&t.hourlyData.length>0?(this.hourlyData=t.hourlyData,this.hourlyDataLoaded=!0,this.currentHourData={hour:this.hourlyData[0].hour||"99:99",solar:this.hourlyData[0].solar||0,temperature:this.hourlyData[0].temperature||99,price:this.hourlyData[0].price||-.001},!0):(console.error("Failed to load hourly data:",t.error),this.hourlyDataLoaded=!0,!1)}catch(t){return console.error("Error loading hourly data:",t),this.hourlyDataLoaded=!0,!1}},handleHourlyDataUpdate(t){t.solarOutput!==void 0&&this.simulationState==="manual"&&this.$emit("solar-output-updated",t.solarOutput),t.energyModels&&(this.energyModels={...this.energyModels,...t.energyModels})},updateFromSimulationStep(){if(!this.isRunning||!this.hourlyDataLoaded)return;const t=this.simulationSteps%96,e=Math.floor(t/4)%this.hourlyData.length;this.hourlyData[e]&&(this.currentHourData={hour:this.hourlyData[e].hour,solar:this.hourlyData[e].solar,temperature:this.hourlyData[e].temperature,price:this.hourlyData[e].price},this.updateCharts(t),this.simulationState==="manual"&&this.updateSimulationFromHourlyData(this.currentHourData))},runHeadlessSimulation(){var n,l;console.log("Starting headless simulation for data recording...");const t={day:this.localSimulationDay,startTime:this.simulationTime,solarOutput:this.solarOutput,outdoorTemperature:((n=this.currentHourData)==null?void 0:n.temperature)||-99,electricityPrice:((l=this.currentHourData)==null?void 0:l.price)||-99,houseDemand:this.houseDemand,gridPower:this.gridPower,batteryLevel:this.batteryLevel,batteryStatus:this.batteryStatus,batteryPower:this.batteryPower,indoorTemperature:this.energyModels.indoorTemperature,waterTemperature:this.energyModels.waterTemperature,evSoC:this.energyModels.evSoC,evConnected:this.energyModels.evConnected,appliances:JSON.parse(JSON.stringify(this.simulatorAppliances)),hourlyData:[...this.hourlyData]},e=[];let i={...t};const a=10,r=2.4,o=2.4;for(let s=0;s<96;s++){const h=Math.floor(s/4)%t.hourlyData.length,p=t.hourlyData[h];if(!p){console.error(`No hourly data available for step ${s}`);continue}const u=i.appliances.find(y=>y.type==="hvac"),d=Mt(i.indoorTemperature,p.temperature,u?u.active:!1),m=i.appliances.find(y=>y.type==="water_heater"),T=it(i.waterTemperature,m?m.active:!1,p.hour),C=i.appliances.find(y=>y.type==="ev_charger"),_=Z(p.hour),H=rt(i.evSoC,_,C?C.active:!1,p.hour,p.price);this.applianceSchedules&&Object.entries(this.applianceSchedules).forEach(([y,k])=>{if(y==="hvac"||y==="water_heater"||y==="ev_charger")return;if(y==="refrigerator"){const K=i.appliances.find(J=>J.type==="refrigerator");K&&(K.active=!0);return}const X=i.appliances.find(K=>K.type===y);if(!X)return;const j=s>=k.startTime&&s<k.endTime;X.active=j});const L=i.appliances.filter(y=>y.active).reduce((y,k)=>y+(parseFloat(k.power)||0),0),I=p.solar;let b=0,E="empty",M="none",O=0,x=0;i.batteryLevel<=a&&(i.batteryStatus==="discharging"||i.batteryPower<0)&&(E="empty",b=0);const V=h>=12&&h<=15||h>=0&&h<=5,B=Math.min(I,L),P=Math.max(0,L-B),R=Math.max(0,I-B);if(V)if(R>0&&i.batteryLevel<100){M="charge",E="charging",b=Math.min(R,r);const y=R-b;y>0?(O=y,x-=O):x=0}else if(h>=0&&h<=5&&i.batteryLevel<100){const y=i.batteryLevel<20?r:1;M="charge",E="charging",b=y,x=P+b}else i.batteryLevel>=99&&R>0?(M="none",E="empty",b=0,O=R,x=P-O):(M="none",E="empty",b=0,x=P);else if(P>0&&i.batteryLevel>a){M="discharge",E="discharging";const y=i.batteryLevel-a,k=Math.min(o,y*.15);b=-Math.min(P,k),x=Math.max(0,P+b)}else if(R>0&&i.batteryLevel<100&&M==="none"){M="charge",E="charging",b=Math.min(R,r);const y=R-b;y>0?(O=y,x=P-O):x=P}else M="none",E="empty",b=0,x=P;const Y=b*.25*.95,z=Math.max(a,Math.min(100,i.batteryLevel+Y/6.4*100));i={...i,indoorTemperature:d.nextIndoorTemp,waterTemperature:T.nextWaterTemp,evSoC:_?H.nextSoC:i.evSoC,evConnected:_,batteryLevel:z,batteryStatus:E,batteryPower:b,gridPower:x,houseDemand:L,solarOutput:I};const D={};i.appliances.forEach(y=>{D[y.type]=y.active?1:0}),e.push({TimeStep:s,SolarPower:I,GridPower:x,ElectricityPrice:p.price,BatterySOC:z,evSOC:_?H.nextSoC:i.evSoC,IndoorTemperature:d.nextIndoorTemp,OutdoorTemperature:p.temperature,WaterTemperature:T.nextWaterTemp,HVACPower:u&&u.active?d.power:0,WaterHeaterPower:m&&m.active?T.power:0,EVChargerPower:C&&C.active?H.power:0,DishwasherActive:D.dishwasher||0,WashMachineActive:D.wash_machine||0,ClothesDryerActive:D.clothes_dryer||0,TVActive:D.tv||0,RefrigeratorActive:D.refrigerator||0,LightsActive:D.lights||0,VacuumActive:D.vacuum||0,HairDryerActive:D.hair_dryer||0}),s%10===0&&console.log(`Headless simulation progress: ${s}/96 steps completed`)}console.log("Headless simulation completed and data exported.")},initializeEnergyModels(t){t&&(this.energyModels.indoorTemperature=ie(t.temperature),this.energyModels.waterTemperature=ae(t.hour),this.energyModels.evConnected=Z(t.hour),this.energyModels.evSoC=se(),this.energyModels.hvacHistory=[],this.energyModels.waterHeaterHistory=[],this.energyModels.evHistory=[],setTimeout(()=>{this.runHeadlessSimulation()},1e3))},updateAppliancePower(t,e){try{const i=this.simulatorAppliances.findIndex(a=>a.id===t);if(i!==-1){const a=parseFloat(e.toFixed(1));return this.$emit("update-appliance-power",{id:t,name:this.simulatorAppliances[i].name,type:this.simulatorAppliances[i].type,power:a,active:this.simulatorAppliances[i].active}),!0}return console.warn(`Appliance with id ${t} not found`),!1}catch(i){return console.error("Error preparing appliance power update:",i),!1}},updateEnergyModels(t){if(!t)return;const e=this.simulatorAppliances.find(l=>l.type==="hvac"),i=this.simulatorAppliances.find(l=>l.type==="water_heater"),a=this.simulatorAppliances.find(l=>l.type==="ev_charger"),r=Mt(this.energyModels.indoorTemperature,t.temperature,e?e.active:!1),o=it(this.energyModels.waterTemperature,i?i.active:!1,t.hour);this.energyModels.evConnected=Z(t.hour);const n=rt(this.energyModels.evSoC,this.energyModels.evConnected,a?a.active:!1,t.hour,t.price);if(this.energyModels.indoorTemperature=r.nextIndoorTemp,this.energyModels.waterTemperature=o.nextWaterTemp,this.energyModels.evConnected&&(this.energyModels.evSoC=n.nextSoC),e&&(e.power=parseFloat(r.power.toFixed(1)),this.updateAppliancePower(e.id,r.power),r.power>0&&!e.active?this.toggleApplianceStatus(e.id):r.power===0&&e.active&&this.toggleApplianceStatus(e.id)),i){const l=this.energyModels.waterTemperature,s=this.waterHeaterConstants.setPoint,h=s-this.waterHeaterConstants.comfortRange,p=l<h,u=it(l,i.active,t.hour);this.energyModels.waterTemperature=u.nextWaterTemp,this.updateAppliancePower(i.id,u.power),p&&!i.active?this.toggleApplianceStatus(i.id):!p&&i.active&&l>=s&&this.toggleApplianceStatus(i.id),i.active&&(i.power=parseFloat(u.power.toFixed(1)))}if(a){const l=this.energyModels.evConnected;this.energyModels.evConnected=Z(t.hour),l!==this.energyModels.evConnected&&(this.energyModels.evConnected?t.price<.2&&this.energyModels.evSoC<.8&&!a.active&&this.toggleApplianceStatus(a.id):a.active&&this.toggleApplianceStatus(a.id));const s=rt(this.energyModels.evSoC,this.energyModels.evConnected,a.active,t.hour,t.price);if(console.log("EV charging status:",{connected:this.energyModels.evConnected,currentSoC:this.energyModels.evSoC,price:t.price,chargingPower:s.power,nextSoC:s.nextSoC,shouldCharge:s.power>.1}),this.energyModels.evConnected&&(this.energyModels.evSoC=s.nextSoC),this.energyModels.evConnected&&s.power>.1&&!a.active?(console.log(`Turning EV charger ON: SoC=${this.energyModels.evSoC.toFixed(2)}, Power=${s.power.toFixed(1)}kW`),this.toggleApplianceStatus(a.id)):this.energyModels.evConnected&&s.power<.1&&a.active?(console.log(`Turning EV charger OFF: SoC=${this.energyModels.evSoC.toFixed(2)}`),this.toggleApplianceStatus(a.id)):!this.energyModels.evConnected&&a.active&&(console.log("Turning EV charger OFF: EV disconnected"),this.toggleApplianceStatus(a.id)),this.updateAppliancePower(a.id,s.power),a.active){const h=parseFloat(s.power.toFixed(1));a.power=h}}if(this.energyModels.hvacHistory.push({time:t.hour,power:r.power,temperature:this.energyModels.indoorTemperature}),this.energyModels.waterHeaterHistory.push({time:t.hour,power:o.power,temperature:this.energyModels.waterTemperature}),this.energyModels.evHistory.push({time:t.hour,power:n.power,soc:this.energyModels.evSoC,connected:this.energyModels.evConnected}),this.energyModels.hvacHistory.length>96&&this.energyModels.hvacHistory.shift(),this.energyModels.waterHeaterHistory.length>96&&this.energyModels.waterHeaterHistory.shift(),this.energyModels.evHistory.length>96&&this.energyModels.evHistory.shift(),this.applianceSchedules){const l=Math.floor(this.simulationElapsedMinutes/15)%96;Object.entries(this.applianceSchedules).forEach(([s,h])=>{if(s==="hvac"||s==="water_heater"||s==="ev_charger")return;if(s==="refrigerator"){const d=this.simulatorAppliances.find(m=>m.type==="refrigerator");d&&!d.active&&this.toggleApplianceStatus(d.id);return}const p=this.simulatorAppliances.find(d=>d.type===s);if(!p)return;(l>=h.startTime&&l<h.endTime)!==p.active&&this.toggleApplianceStatus(p.id)})}this.recalculateHouseDemand(),this.$emit("energy-models-updated",{indoorTemperature:this.energyModels.indoorTemperature,waterTemperature:this.energyModels.waterTemperature,evSoC:this.energyModels.evSoC,evConnected:this.energyModels.evConnected,hvacPower:r.power,waterHeaterPower:o.power,evPower:n.power})},recalculateHouseDemand(){let t=0;return this.simulatorAppliances.forEach(i=>{if(i.active){const a=parseFloat(i.power||0);isNaN(a)||(t+=a)}}),parseFloat(t.toFixed(1))},updateSimulationFromHourlyData(t){if(t){if(this.energyModels.hvacHistory.length||this.initializeEnergyModels(t),this.updateEnergyModels(t),this.$emit("solar-output-updated",t.solar),t.temperature){const e=this.simulatorAppliances.find(i=>i.type==="hvac");if(e){const i=t.temperature>25,a=t.temperature<18;(i||a)&&!e.active?this.toggleApplianceStatus(e.id):!i&&!a&&e.active&&this.toggleApplianceStatus(e.id)}}if(t.price){const e=this.simulatorAppliances.find(i=>i.type==="ev_charger");if(e&&this.energyModels.evConnected){const i=t.price<.15,a=t.price>.2,o=this.energyModels.evSoC>.8;i&&!o&&!e.active?(console.log(`Smart charging: Low price (${t.price}), turning EV charger ON`),this.toggleApplianceStatus(e.id)):a&&e.active&&(console.log(`Smart charging: High price (${t.price}), turning EV charger OFF`),this.toggleApplianceStatus(e.id))}}this.$emit("hourly-data-update",{solarOutput:t.solar,temperature:t.temperature,price:t.price,hour:t.hour,simulationStep:this.simulationSteps,energyModels:{indoorTemperature:this.energyModels.indoorTemperature,waterTemperature:this.energyModels.waterTemperature,evSoC:this.energyModels.evSoC,evConnected:this.energyModels.evConnected}}),this.simulationSteps++}},handleVisibilityChange(){document.visibilityState==="visible"&&this.isRunning&&(console.log("Page became visible, refreshing energy flows and power values"),this.updateConnectionsStatus())},handleBatteryCritical(){this.batteryLevel<=10.01&&(this.batteryStatus==="discharging"||this.batteryPower<0)&&(console.log(`Battery protection: Level ${this.batteryLevel.toFixed(1)}% reached minimum threshold`),this.batteryStatus="empty",this.batteryPower=0,this.$emit("battery-critical",{batteryStatus:"empty",batteryPower:0,batteryLevel:this.batteryLevel}),this.updateConnectionsStatus())}},watch:{appliances:{handler(t){if(t&&t.length>0){let e=!1;this.simulatorAppliances=this.simulatorAppliances.map(i=>{const a=t.find(r=>r.id===i.id);return a&&(a.active!==i.active||a.power!==i.power)?(e=!0,{...i,active:a.active,power:parseFloat(a.power||i.power)}):i}),e&&this.updateConnectionsStatus()}},deep:!0},powerData:{handler(){this.updatePowerSourcesFromProps(),this.updateConnectionsStatus()},deep:!0},rlPrediction(t){t&&typeof t.timestamp=="number"&&this.updateHistoryData()},simulationFormattedTime(t){this.simulationTime=t;const[e,i]=t.split(":").map(Number),a=e*60+i;this.isRunning&&(this.elapsedMinutes=a+this.localSimulationDay*24*60)},simulationDay(t){this.localSimulationDay=t},simulationElapsedMinutes:function(t){if(!this.isRunning)return;const e=Math.floor(t/15);Math.abs(e-this.simulationSteps)>1&&(this.simulationSteps=e,this.updateFromSimulationStep())},simulationSteps(t,e){if(t!==e&&this.isRunning){const i=t%96;this.updateCharts(i)}},batteryLevel:{handler(t,e){if(t!==e&&this.isRunning&&this.hourlyDataLoaded){const i=this.simulationSteps%96;this.updateBatteryHistory(i,t)}}},gridPower:{handler(t,e){var i;if(t!==e&&this.isRunning&&this.hourlyDataLoaded){const a=this.simulationSteps%96,r=((i=this.currentHourData)==null?void 0:i.price)||0;this.updatePriceChart(a,r,t)}}}},mounted(){if(typeof window.ApexCharts>"u"){console.warn("ApexCharts not found, attempting to load from CDN");const t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/apexcharts",t.async=!0,t.onload=()=>{console.log("ApexCharts loaded from CDN"),this.$nextTick(()=>{this.initCharts()})},t.onerror=e=>{console.error("Failed to load ApexCharts from CDN:",e)},document.head.appendChild(t)}else this.initCharts();document.documentElement.style.setProperty("--animation-duration",`${1/this.selectedSpeed}s`),this.$nextTick(()=>{const t=this.speedOptions.find(e=>e.value===this.selectedSpeed);t&&this.updateAnimationSpeed(t.value)}),this.$watch("simulationSteps",(t,e)=>{console.log(`Simulation step changed: ${e} -> ${t}`),this.isRunning&&t!==e&&this.updateCharts(t%96)}),this.$watch("hourlyDataLoaded",t=>{t&&!this.charts.solar&&(console.log("Hourly data loaded, initializing charts"),this.$nextTick(()=>{this.initCharts()}))}),this.$watch("isRunning",t=>{console.log(`Simulation running state changed to: ${t}`),t&&this.hourlyDataLoaded&&(!this.charts.solar||!this.charts.temperature||!this.charts.price)&&(console.log("Simulation started but charts not initialized, initializing now"),this.$nextTick(()=>{this.initCharts()}))}),this.chartUpdateInterval=setInterval(()=>{if(this.isRunning&&this.hourlyDataLoaded&&this.simulationSteps>0){const t=this.simulationSteps%96;Math.abs(t-this.lastUpdatedStep)>=5&&this.updateCharts(t)}},1e3),this.applianceSchedules=oe(),document.addEventListener("visibilitychange",this.handleVisibilityChange)},beforeDestroy(){this.chartUpdateInterval&&clearInterval(this.chartUpdateInterval),this.cleanupCharts(),this.$nextTick(()=>{document.querySelectorAll(".apexcharts-canvas").forEach(e=>{e&&e.parentNode&&e.parentNode.removeChild(e)})}),document.removeEventListener("visibilitychange",this.handleVisibilityChange)}},le={class:"energy-flow-container"},he={class:"controls"},ce={key:0,class:"config-controls"},ue={class:"simulation-time-input"},pe={class:"control-buttons"},de={class:"speed-control",style:{display:"flex"}},me=["value"],fe={key:0,class:"simulation-time-display"},ye={class:"time-value"},ge={key:0,class:"time-day"},we={class:"diagram"},Se={width:"100%",height:"400",viewBox:"0 0 1000 400"},ve=["x1","y1","x2","y2","stroke","stroke-width"],Ce=["x","y","fill"],Te=["transform"],be=["x","y","width","height","rx"],Ae=["x","y","width","height","href"],_e=["x","y","width","height","innerHTML"],xe=["x","y"],Ee=["x","y"],Pe={class:"appliances-and-charts"},De={class:"appliances-column"},Me={class:"appliances-group"},Re=["onClick"],He=["src"],Ie=["innerHTML"],Oe={class:"appliance-name"},ke={key:0,class:"charts-column"},Le={class:"environmental-charts"},Fe=["id"],Ne={key:0,class:"current-value"},Ue={class:"chart-container"},Ge={key:0,class:"current-value"},We={class:"chart-container",style:{"margin-top":"20px"}},$e={key:0,class:"current-value"},Be={class:"energy-stats"},ze={class:"stat-title"},Ve={class:"stat-value"},Ye={key:1,class:"rl-insights"},Xe={class:"rl-stats"},Ke={class:"rl-stat-title"},qe={class:"rl-chart-container"};function je(t,e,i,a,r,o){const n=at("temperature-chart"),l=at("appliance-power-chart");return f(),g("div",le,[c("div",he,[i.simulationState==="idle"?(f(),g("div",ce,[c("div",ue,[e[9]||(e[9]=c("label",{for:"simulation-hours"},"Simulation hours:",-1)),Pt(c("input",{id:"simulation-hours",type:"number","onUpdate:modelValue":e[0]||(e[0]=s=>r.simulationHours=s),min:"0.1",step:"0.1",placeholder:"Hours"},null,512),[[kt,r.simulationHours,void 0,{number:!0}]]),e[10]||(e[10]=c("span",null,"hours",-1))]),c("button",{onClick:e[1]||(e[1]=(...s)=>o.loadConfigFile&&o.loadConfigFile(...s)),class:"config-btn"}," Load Configuration "),c("input",{type:"file",ref:"configFileInput",onChange:e[2]||(e[2]=(...s)=>o.onConfigFileSelected&&o.onConfigFileSelected(...s)),accept:".json,.yaml,.yml",style:{display:"none"}},null,544)])):F("",!0),c("div",pe,[c("button",{style:G({display:i.simulationState==="idle"?"inline-block":"none"}),onClick:e[3]||(e[3]=(...s)=>o.startSimulation&&o.startSimulation(...s)),class:"start-btn"}," Start ",4),c("button",{style:G({display:i.isRunning&&i.simulationState!=="idle"?"inline-block":"none"}),onClick:e[4]||(e[4]=(...s)=>o.pauseSimulation&&o.pauseSimulation(...s)),class:"pause-btn"}," Pause ",4),c("button",{style:G({display:!i.isRunning&&i.simulationState!=="idle"&&!i.simulationCompleted?"inline-block":"none"}),onClick:e[5]||(e[5]=(...s)=>o.resumeSimulation&&o.resumeSimulation(...s)),class:"resume-btn"}," Resume ",4),c("button",{style:G({display:i.simulationState!=="idle"?"inline-block":"none"}),onClick:e[6]||(e[6]=(...s)=>o.resetSimulation&&o.resetSimulation(...s)),class:"reset-btn"}," Reset ",4),c("div",de,[e[11]||(e[11]=c("span",null,"Animation speed:",-1)),Pt(c("select",{"onUpdate:modelValue":e[7]||(e[7]=s=>r.selectedSpeed=s),onChange:e[8]||(e[8]=(...s)=>o.onSpeedChange&&o.onSpeedChange(...s))},[(f(!0),g(W,null,$(r.speedOptions,s=>(f(),g("option",{key:s.value,value:s.value},v(s.label),9,me))),128))],544),[[Lt,r.selectedSpeed]])])])]),i.isRunning||i.simulationState!=="idle"?(f(),g("div",fe,[e[12]||(e[12]=c("div",{class:"time-icon"},[c("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[c("circle",{cx:"12",cy:"12",r:"10"}),c("polyline",{points:"12 6 12 12 16 14"})])],-1)),c("div",ye,v(o.formattedSimulationTime),1),r.localSimulationDay>1?(f(),g("div",ge,"Day "+v(r.localSimulationDay),1)):F("",!0)])):F("",!0),c("div",we,[(f(),g("svg",Se,[e[13]||(e[13]=c("pattern",{id:"grid",width:"50",height:"50",patternUnits:"userSpaceOnUse"},[c("path",{d:"M 50 0 L 0 0 0 50",fill:"none",stroke:"#eee","stroke-width":"1"})],-1)),e[14]||(e[14]=c("rect",{width:"100%",height:"100%",fill:"url(#grid)"},null,-1)),(f(!0),g(W,null,$(r.activeConnections,(s,h)=>(f(),g("g",{key:`conn-${h}`},[c("line",{x1:s.x1,y1:s.y1,x2:s.x2,y2:s.y2,stroke:s.color,"stroke-width":s.strokeWidth,"stroke-dasharray":"5,5",class:N({"flow-line":!0,[`flow-${s.direction}`]:i.isRunning&&s.powerFlow>.1&&s.active&&(s.from!=="battery"||i.batteryLevel>10.01)})},null,10,ve),s.active&&s.powerFlow>.1?(f(),g("text",{key:0,x:s.labelX,y:s.labelY,fill:s.color,"text-anchor":"middle","font-size":"12","font-weight":"bold",class:"flow-value"},v(s.powerFlow.toFixed(1))+" kW ",9,Ce)):F("",!0)]))),128)),(f(!0),g(W,null,$(r.powerSources,s=>(f(),g("g",{key:s.id,class:N(["device-icon",{pulse:s.active&&i.simulationState==="running"}]),transform:`translate(${s.x}, ${s.y})`},[c("rect",{x:s.rectX,y:s.rectY,width:s.width,height:s.height,rx:s.rx,class:N(["device-bg",{active:s.active}]),style:G({fill:s.bgFill,stroke:s.stroke})},null,14,be),s.customIcon?(f(),g("image",{key:0,x:s.iconX,y:s.iconY,width:s.iconWidth,height:s.iconHeight,href:s.customIcon,style:G({opacity:s.active?1:.5})},null,12,Ae)):(f(),g("svg",{key:1,x:s.iconX,y:s.iconY,width:s.iconWidth,height:s.iconHeight,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",style:G({color:s.active?s.stroke:"#9ca3af"}),innerHTML:o.getIconSvg(s.type)},null,12,_e)),c("text",{x:s.labelX,y:s.labelY,class:"device-label"},v(s.name),9,xe),c("text",{x:s.valueX,y:s.valueY,class:"device-value",style:G({fill:s.active?s.stroke:"#9ca3af"})},v(s.displayValue),13,Ee)],10,Te))),128))]))]),c("div",Pe,[c("div",De,[(f(),g(W,null,$([1,2,3],s=>c("div",{key:`group-${s}`,class:"appliance-group"},[c("div",{class:N(`appliance-group-header group-${s}`)},v(o.getGroupTitle(s)),3),c("div",Me,[(f(!0),g(W,null,$(r.simulatorAppliances.filter(h=>h.group===s),h=>(f(),g("div",{key:h.id,class:N(`appliance-card group-${s} ${h.active?"active":""}`),onClick:p=>o.toggleApplianceStatus(h.id)},[c("div",{class:N(["appliance-icon",{pulse:h.active&&i.simulationState==="running"}])},[o.getApplianceIcon(h.type).type==="image"?(f(),g("image",{key:0,src:o.getApplianceIcon(h.type).path,width:"24",height:"24",style:G({opacity:h.active?1:.5})},null,12,He)):(f(),g("svg",{key:1,width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",style:G({color:h.active?o.getGroupColor(s):"#9ca3af"}),innerHTML:o.getApplianceSvg(h.type)},null,12,Ie))],2),c("div",Oe,v(h.name),1),c("div",{class:N(["appliance-power",{active:h.active}])},v(h.power)+" kW ",3),c("div",{class:N(["appliance-status",{on:h.active,off:!h.active}])},v(h.active?"ON":"OFF"),3)],10,Re))),128))])])),64))]),r.hourlyDataLoaded?(f(),g("div",ke,[c("div",Le,[e[18]||(e[18]=c("h3",null,"Environmental Data",-1)),(f(),g(W,null,$(["solar","price"],s=>c("div",{key:s,class:"chart-container"},[c("h4",null,v(o.getChartTitle(s)),1),c("div",{class:"chart-wrapper",id:`${s}-chart-container`},null,8,Fe),r.currentHourData?(f(),g("div",Ne," Current: "+v(o.formatChartValue(s,r.currentHourData[s])),1)):F("",!0)])),64)),c("div",Ue,[c("h4",null,v(o.getChartTitle("temperature")),1),e[15]||(e[15]=c("div",{class:"chart-wrapper"},[c("div",{id:"air-temp-chart-container",style:{height:"160px",width:"100%"}})],-1)),r.currentHourData?(f(),g("div",Ge," Current: "+v(o.formatChartValue("temperature",r.currentHourData.temperature)),1)):F("",!0)]),c("div",We,[e[16]||(e[16]=c("h4",null,"Water Temperature (°C)",-1)),e[17]||(e[17]=c("div",{class:"chart-wrapper"},[c("div",{id:"water-temp-chart-container",style:{height:"160px",width:"100%"}})],-1)),r.energyModels?(f(),g("div",$e," Current: "+v(r.energyModels.waterTemperature.toFixed(1))+"°C ",1)):F("",!0)])])])):F("",!0)]),c("div",Be,[(f(!0),g(W,null,$(o.energyStats,s=>(f(),g("div",{key:s.type,class:N(`stat-card ${s.type}`)},[c("div",ze,v(s.title),1),c("div",Ve,v(s.value),1)],2))),128))]),i.rlPrediction?(f(),g("div",Ye,[e[19]||(e[19]=c("h3",null,"AI Energy Optimizer",-1)),c("div",Xe,[(f(!0),g(W,null,$(o.rlStats,s=>(f(),g("div",{key:s.id,class:"rl-stat-card"},[c("div",Ke,v(s.title),1),c("div",{class:N(["rl-stat-value",s.class])},v(s.value),3)]))),128))]),(f(),g(W,null,$(["home","water"],s=>c("div",{key:`${s}-temp`,class:"rl-chart-container"},[(f(),Dt(n,{key:`${s}-temp-${o.safeGet(i.rlPrediction,"timestamp",0)}-reset-${r.resetCounter}`,title:`${s.charAt(0).toUpperCase()+s.slice(1)} Temperature`,"current-temperature":o.safeGet(i.rlPrediction,`temperatures.${s}.current`,s==="home"?22:60),"set-point":o.safeGet(i.rlPrediction,`temperatures.${s}.setpoint`,s==="home"?22:60),"time-step":o.safeGet(i.rlPrediction,"timestamp",0),history:s==="home"?r.homeTemperatureHistory:r.waterTemperatureHistory},null,8,["title","current-temperature","set-point","time-step","history"]))])),64)),c("div",qe,[i.rlPrediction&&i.rlPrediction.appliances&&i.rlPrediction.appliances.shiftable?(f(),Dt(l,{key:`appliance-power-${o.safeGet(i.rlPrediction,"timestamp",0)}-reset-${r.resetCounter}`,"shiftable-appliances":i.rlPrediction.appliances.shiftable,"time-step":o.safeGet(i.rlPrediction,"timestamp",0),"power-history":r.appliancePowerHistory},null,8,["shiftable-appliances","time-step","power-history"])):F("",!0)])])):F("",!0)])}const Je=tt(ne,[["render",je]]);const Ze={components:{EnergyFlowDiagram:Je},data(){return{currentSimulationStep:0,showRlControls:!0,simulationRunning:!1,simulationState:"idle",simulationTimer:null,simulationInterval:500,simulationElapsedTime:0,solarOutput:0,batteryLevel:35,batteryStatus:"empty",batteryPower:0,gridPower:0,houseDemand:0,simulationElapsedMinutes:0,simulationFormattedTime:"00:00",simulationDay:1,hourlyData:{temperature:0,solarOutput:0,price:0,hour:"00:00"},simulationSteps:0,maxSimulationSteps:null,simulationCompleted:!1,energyModelState:{indoorTemperature:24,waterTemperature:55,evSoC:0,evConnected:!1,hvacPower:0,waterHeaterPower:0,evPower:0},appliances:[],initialState:{solarOutput:0,batteryLevel:35,batteryStatus:"empty",batteryPower:0,gridPower:0,houseDemand:0},rlPrediction:null,currentDay:1,currentTimeStep:0,autoPlayActive:!1,autoPlayTimer:null,homeTemperatureHistory:new Array(96).fill(null),waterTemperatureHistory:new Array(96).fill(null),appliancePowerHistory:{dishwasher:new Array(96).fill(0),wash_machine:new Array(96).fill(0),clothes_dryer:new Array(96).fill(0)}}},mounted(){this.appliances.length===0&&(this.appliances=[{id:1,name:"Dishwasher",type:"dishwasher",power:1.8,active:!1,group:1},{id:2,name:"Wash Machine",type:"wash_machine",power:.4,active:!1,group:1},{id:3,name:"Clothes Dryer",type:"clothes_dryer",power:1.2,active:!1,group:1},{id:4,name:"HVAC",type:"hvac",power:2.5,active:!1,group:2},{id:5,name:"Water Heater",type:"water_heater",power:4.5,active:!1,group:2},{id:6,name:"EV Charger",type:"ev_charger",power:6,active:!1,group:2},{id:7,name:"TV",type:"tv",power:.1,active:!1,group:3},{id:8,name:"Refrigerator",type:"refrigerator",power:.2,active:!1,group:3},{id:9,name:"Lights",type:"lights",power:.2,active:!1,group:3},{id:10,name:"Vacuum Cleaner",type:"vacuum",power:1.2,active:!1,group:3},{id:11,name:"Hair Dryer",type:"hair_dryer",power:1,active:!1,group:3}]);const t=io("http://localhost:3000",{transports:["websocket","polling"]});this.socket=t,t.on("connect",()=>{console.log("Socket connected!"),this.socket.emit("get_current_state")}),t.on("disconnect",()=>{console.log("Socket disconnected!")}),t.on("rl_prediction",e=>{e&&typeof e.timestamp<"u"&&typeof e.day<"u"?(this.rlPrediction=e,this.updateSimulationFromRl(e),this.updateHistoryData(e)):console.warn("Received invalid RL prediction data:",e)}),t.on("rl_error",e=>{console.error("RL prediction error:",e)}),t.on("simulation_mode_changed",e=>{this.simulationState=e.mode,console.log(`Simulation mode changed to: ${e.mode}`)}),t.on("connect_error",e=>{console.error("Socket connection error:",e)}),t.on("simulation_update",e=>{e.simulationMode==="manual"&&(this.solarOutput=e.solarOutput||0,this.batteryLevel=e.batteryLevel||35,this.batteryStatus=e.batteryStatus||"empty",this.batteryPower=e.batteryPower||0,this.gridPower=e.gridDraw||0,this.houseDemand=e.houseDemand||0,this.simulationElapsedMinutes=e.elapsedMinutes||0,this.simulationFormattedTime=e.formattedTime||"00:00",this.simulationDay=Math.floor(this.simulationElapsedMinutes/(24*60))+1,e.energyModels&&(this.energyModelState={...this.energyModelState,...e.energyModels}),this.simulationSteps++,e.devices&&e.devices.length>0&&(this.appliances=this.appliances.map(i=>{const a=e.devices.find(r=>r.Type===i.type);return a?{...i,active:a.Status==="active",power:a.PowerLevel}:i})))}),t.on("simulation_status",e=>{this.simulationRunning=e.running,e.mode&&(this.simulationState=e.mode,this.showRlControls=!0),e.preservedTime&&e.elapsedMinutes&&(this.simulationElapsedMinutes=e.elapsedMinutes),e.timeLimitReached&&(this.simulationRunning=!1)}),t.on("error",e=>{console.error("Socket error:",e),alert(`Socket error: ${e.message||"Unknown error"}`)}),t.on("simulation_reset",e=>{this.simulationRunning=!1,this.simulationState="idle",this.solarOutput=e.solarOutput||0,this.batteryLevel=e.batteryLevel||35,this.batteryStatus=e.batteryStatus||"empty",this.batteryPower=e.batteryPower||0,this.gridPower=e.gridDraw||0,this.houseDemand=e.houseDemand||0,this.currentDay=1,this.currentTimeStep=0,this.rlPrediction=null,this.autoPlayActive&&(clearInterval(this.autoPlayTimer),this.autoPlayActive=!1),this.appliances=this.appliances.map(i=>({...i,active:!1})),this.homeTemperatureHistory=new Array(96).fill(null),this.waterTemperatureHistory=new Array(96).fill(null),this.appliancePowerHistory={dishwasher:new Array(96).fill(0),wash_machine:new Array(96).fill(0),clothes_dryer:new Array(96).fill(0)}}),t.on("devices_updated",e=>{e.houseDemand&&(this.houseDemand=e.houseDemand)}),t.on("simulation_time_limit_reached",e=>{this.simulationRunning=!1,this.simulationCompleted=!0,this.showTimeLimitNotification(e)}),t.on("energy_models_update_ack",e=>{console.log("Energy models update acknowledged by server",e)})},methods:{handleBatteryCritical(){this.batteryLevel<=10.01&&(this.batteryStatus==="discharging"||this.batteryPower<0)&&(console.log(`Battery protection: Level ${this.batteryLevel.toFixed(1)}% reached minimum threshold`),this.batteryStatus="empty",this.batteryPower=0,this.socket&&this.socket.emit("update_battery_state",{batteryStatus:"empty",batteryPower:0,batteryLevel:this.batteryLevel,useGridForRemaining:!0}))},handleAppliancePowerUpdate(t){const e=this.appliances.findIndex(i=>i.id===t.id);if(e!==-1){console.log(`App.vue updating ${t.name} power from ${this.appliances[e].power} to ${t.power} kW`);const i=[...this.appliances];i[e]={...i[e],power:t.power},this.appliances=i,this.calcHouseDemand(),this.socket&&this.socket.emit("update_devices",{devices:this.appliances.map(a=>({id:a.id,name:a.name,type:a.type,power:a.power,active:a.active}))})}else console.warn(`Appliance with id ${t.id} not found in App.vue`)},calcHouseDemand(){const t=parseFloat(this.appliances.filter(e=>e.active).reduce((e,i)=>e+(parseFloat(i.power)||0),0).toFixed(1));this.houseDemand=t},onDataLoaded(t){console.log("Hourly data loaded:",t),this.hourlyDataLoaded=!0},onHourDataUpdated(t){this.currentHourData=t},showAlert(t){setTimeout(()=>{try{window.alert(t)}catch(e){console.error("Error showing alert:",e)}},100)},startSimulation(t={}){this.simulationRunning=!0,this.simulationState="manual",this.simulationSteps=0,this.completionAlertShown=!1,this.simulationMessage="";const e=t.timeLimit?t.timeLimit/3600:this.simulationHours||1,i=Math.floor(e*4);console.log(`Starting simulation for ${e} hours (${i} steps)`),this.maxSimulationSteps=t.maxSteps||i,this.simulationElapsedMinutes=0,this.socket&&(this.socket.emit("start_simulation",{timeLimit:e*3600,initialState:{simulationMode:"manual"},interval:this.simulationInterval}),this.simulationProgressTimer&&clearInterval(this.simulationProgressTimer),this.simulationProgressTimer=setInterval(()=>{this.checkSimulationCompletion()},1e3))},validateApplianceState(t){return!t||!Array.isArray(t)?t:t.map(e=>{const i={...e};return i.active&&(i.power===0||isNaN(i.power))&&(i.power=i.defaultPower||1,console.log(`Fixed zero power for active appliance: ${i.name}`)),i})},checkSimulationCompletion(){this.maxSimulationSteps&&this.simulationRunning&&Math.floor(this.simulationElapsedMinutes/15)>=this.maxSimulationSteps&&(console.log("Simulation complete - reached time limit"),this.pauseSimulation(),this.simulationMessage="Simulation complete - reached end of data",this.completionAlertShown||(this.completionAlertShown=!0,setTimeout(()=>{try{alert("Simulation complete. Reached the end of available data.")}catch(e){console.error("Error showing completion alert:",e)}},100)))},handleHourlyDataUpdate(t){t&&(t.devices=this.validateApplianceState(t.devices),this.hourlyData=t,t.energyModels&&(this.energyModelState={...this.energyModelState,...t.energyModels})),t&&this.simulationState==="manual"&&this.simulationRunning&&(typeof t.solarOutput=="number"&&(this.$emit("solar-output-updated",t.solarOutput),this.socket&&this.socket.emit("hourly_data_update",{solarOutput:t.solarOutput,temperature:t.temperature||0,price:t.price||0,hour:t.hour||"00:00",simulationStep:t.simulationStep,energyModels:t.energyModels||null})),this.simulationSteps++)},handleSimulationComplete(){this.pauseSimulation()},handleEnergyModelsUpdate(t){this.energyModelState=t,this.simulationState==="manual"&&this.simulationRunning&&this.socket&&this.socket.emit("energy_models_update",t)},pauseSimulation(){this.simulationRunning=!1,this.autoPlayActive&&(clearInterval(this.autoPlayTimer),this.autoPlayTimer=null,this.autoPlayActive=!1),this.optimizeMemoryUsage(),this.socket&&this.socket.emit("stop_simulation")},resumeSimulation(){if(this.simulationRunning=!0,this.socket){let t=60;try{if(this.selectedSpeed!==void 0&&Array.isArray(this.speedOptions)){const e=this.speedOptions.find(i=>i.value===this.selectedSpeed);e&&(t=e.value*30)}}catch(e){console.warn("Could not determine timeScale from speed options:",e)}this.socket.emit("start_simulation",{initialState:{simulationMode:this.simulationState,devices:this.appliances.map(e=>({id:e.id,name:e.name,type:e.type,power:e.power,active:e.active})),preserveTime:!0,elapsedMinutes:this.simulationElapsedMinutes,timeScale:t},interval:this.simulationInterval||1e3,maxSteps:this.maxSimulationSteps})}},resetSimulation(){this.simulationRunning=!1,this.simulationState="idle",this.simulationCompleted=!1,this.autoPlayActive&&(clearInterval(this.autoPlayTimer),this.autoPlayTimer=null,this.autoPlayActive=!1),this.solarOutput=this.initialState.solarOutput,this.batteryLevel=this.initialState.batteryLevel,this.batteryStatus=this.initialState.batteryStatus,this.batteryPower=0,this.gridPower=this.initialState.gridPower,this.houseDemand=this.initialState.houseDemand,this.currentDay=1,this.currentTimeStep=0,this.rlPrediction=null,this.appliances=this.appliances.map(t=>({...t,active:!1})),this.homeTemperatureHistory=new Array(96).fill(null),this.waterTemperatureHistory=new Array(96).fill(null),this.appliancePowerHistory={dishwasher:new Array(96).fill(0),wash_machine:new Array(96).fill(0),clothes_dryer:new Array(96).fill(0)},this.socket&&this.socket.emit("reset_simulation"),U.optimizeMemoryUsage(),this.energyModelState={indoorTemperature:24,waterTemperature:55,evSoC:0,evConnected:!1,hvacPower:0,waterHeaterPower:0,evPower:0}},optimizeMemoryUsage(){if(this.pendingAnimationFrames=[],this.currentTimeStep>0){const e=Math.max(0,this.currentTimeStep-10);for(let i=0;i<e;i++)this.homeTemperatureHistory&&(this.homeTemperatureHistory[i]=null),this.waterTemperatureHistory&&(this.waterTemperatureHistory[i]=null)}},toggleAppliance(t){if(typeof t=="number"||typeof t=="string"){this.appliances=this.appliances.map(i=>i.id===t?{...i,active:!i.active}:i);const e=parseFloat(this.appliances.filter(i=>i.active).reduce((i,a)=>i+(parseFloat(a.power)||0),0).toFixed(1));if(this.simulationRunning&&this.simulationState==="manual"&&this.socket){const i={devices:this.appliances.map(a=>({id:a.id,name:a.name,type:a.type,power:a.power,active:a.active})),houseDemand:e};this.socket.emit("update_devices",i)}}else t&&t.devices&&(this.appliances=this.appliances.map(e=>{const i=t.devices.find(a=>a.id===e.id);return i?{...e,active:i.active}:e}),t.newDemand!==void 0&&(this.houseDemand=t.newDemand))},updateHouseDemand(t){this.houseDemand=t},updateGridPower(t){this.gridPower=t},handleSpeedChange(t){this.simulationInterval=t.interval;const e=t.animationSpeed*30;this.simulationRunning&&this.socket&&(this.socket.emit("set_time_scale",{timeScale:e,animationSpeed:t.animationSpeed}),this.autoPlayActive&&(clearInterval(this.autoPlayTimer),this.autoPlayTimer=setInterval(()=>{this.nextStep()},t.interval)))},handleConfigUpdated(t){t.appliances&&(this.appliances=t.appliances.map(e=>({id:e.id,name:e.name,type:e.type||"other",power:parseFloat(e.power||e.defaultPower)||0,defaultPower:parseFloat(e.defaultPower)||0,active:!!e.active,group:e.group||3})),console.log("Updated appliances from config:",this.appliances)),this.simulationRunning=!1,this.simulationState="idle",this.batteryStatus="empty",this.solarOutput=0,this.gridPower=0,this.houseDemand=0},updateSimulationFromRl(t){var e,i,a,r,o,n,l,s,h,p;if(!t||t.error){console.warn("Invalid RL prediction:",(t==null?void 0:t.error)||"Missing data");return}if(!t.appliances||!t.environment||!t.battery||!t.energy_flow){console.error("Invalid RL prediction data structure:",t);return}this.appliances=this.appliances.map(u=>{var T,C,_,H,L,I,b,E,M,O,x,V,B,P,R,Y,z,D,y,k;let d=u.active,m=u.power;try{u.type==="hvac"&&((C=(T=t.appliances)==null?void 0:T.controllable)!=null&&C.hvac)?(d=t.appliances.controllable.hvac.active,m=t.appliances.controllable.hvac.power):u.type==="water_heater"&&((H=(_=t.appliances)==null?void 0:_.controllable)!=null&&H.water_heater)?(d=t.appliances.controllable.water_heater.active,m=t.appliances.controllable.water_heater.power):u.type==="ev_charger"&&t.ev?(d=t.ev.power>0,m=t.ev.power):u.type==="dishwasher"&&((I=(L=t.appliances)==null?void 0:L.shiftable)!=null&&I.dishwasher)?(d=t.appliances.shiftable.dishwasher.active,m=t.appliances.shiftable.dishwasher.power):u.type==="wash_machine"&&((E=(b=t.appliances)==null?void 0:b.shiftable)!=null&&E.wash_machine)?(d=t.appliances.shiftable.wash_machine.active,m=t.appliances.shiftable.wash_machine.power):u.type==="clothes_dryer"&&((O=(M=t.appliances)==null?void 0:M.shiftable)!=null&&O.clothes_dryer)?(d=t.appliances.shiftable.clothes_dryer.active,m=t.appliances.shiftable.clothes_dryer.power):u.type==="tv"&&((V=(x=t.appliances)==null?void 0:x.fixed)!=null&&V.tv)?(d=t.appliances.fixed.tv.active,m=t.appliances.fixed.tv.power):u.type==="refrigerator"&&((P=(B=t.appliances)==null?void 0:B.fixed)!=null&&P.refrigerator)?(d=t.appliances.fixed.refrigerator.active,m=t.appliances.fixed.refrigerator.power):u.type==="lights"&&((Y=(R=t.appliances)==null?void 0:R.fixed)!=null&&Y.lights)?(d=t.appliances.fixed.lights.active,m=t.appliances.fixed.lights.power):u.type==="vacuum"&&((D=(z=t.appliances)==null?void 0:z.fixed)!=null&&D.vacuum)?(d=t.appliances.fixed.vacuum.active,m=t.appliances.fixed.vacuum.power):u.type==="hair_dryer"&&((k=(y=t.appliances)==null?void 0:y.fixed)!=null&&k.hair_dryer)&&(d=t.appliances.fixed.hair_dryer.active,m=t.appliances.fixed.hair_dryer.power)}catch(X){console.error(`Error updating ${u.name}:`,X)}return{...u,active:d,power:m}}),this.solarOutput=((e=t.environment)==null?void 0:e.solar_production)||0,this.gridPower=((a=(i=t.energy_flow)==null?void 0:i.grid)==null?void 0:a.net_power)||0,this.houseDemand=((n=(o=(r=t.energy_flow)==null?void 0:r.house)==null?void 0:o.demand)==null?void 0:n.total)||0,this.batteryLevel=(((l=t.battery)==null?void 0:l.soc)||0)*100,this.batteryPower=((s=t.battery)==null?void 0:s.power)||0,((h=t.battery)==null?void 0:h.power)>0?this.batteryStatus="charging":((p=t.battery)==null?void 0:p.power)<0?this.batteryStatus="discharging":this.batteryStatus="empty"},onHistoryUpdated(t){console.log(`History updated for timeStep ${t.timeStep}`),t.timeStep===this.currentTimeStep&&(t.homeTemp!==null&&(this.homeTemperatureHistory[t.timeStep]=t.homeTemp),t.waterTemp!==null&&(this.waterTemperatureHistory[t.timeStep]=t.waterTemp))},updateHistoryData(t){var e,i,a,r;if(t)try{const o=t.timestamp;if(o>=0&&o<96){const n=[...this.homeTemperatureHistory],l=[...this.waterTemperatureHistory],s=JSON.parse(JSON.stringify(this.appliancePowerHistory)),h=((i=(e=t.temperatures)==null?void 0:e.home)==null?void 0:i.current)||null;n[o]=h;const p=((r=(a=t.temperatures)==null?void 0:a.water)==null?void 0:r.current)||null;l[o]=p;const u=t.appliances.shiftable.wash_machine,d=u.progress>=u.total_duration,m=t.appliances.shiftable.clothes_dryer;if(t.appliances&&t.appliances.shiftable){for(const T in t.appliances.shiftable)if(s[T]){const C=t.appliances.shiftable[T];let _=0;T==="clothes_dryer"?_=C.progress<C.total_duration&&d?C.power:0:_=C.active&&C.progress<C.total_duration?C.power:0,s[T][o]=_}}this.homeTemperatureHistory=n,this.waterTemperatureHistory=l,this.appliancePowerHistory=s}}catch(o){console.error("Error in updateHistoryData:",o)}},formatTime(t){const e=(t+32)%96,i=e%4*15;return`${Math.floor(e/4).toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`},previousStep(){if(this.canGoBack&&!this.autoPlayActive){const t=this.currentDay,e=this.currentTimeStep;this.currentTimeStep=(this.currentTimeStep-1+96)%96,this.currentTimeStep===95&&(this.currentDay=Math.max(1,this.currentDay-1)),console.log(`Time step changed: ${t}:${e} -> ${this.currentDay}:${this.currentTimeStep}`),this.requestRlPrediction()}},nextStep(){if(this.autoPlayActive)return;const t=this.currentDay,e=this.currentTimeStep;this.currentTimeStep=(this.currentTimeStep+1)%96,this.currentTimeStep===0&&(this.currentDay=Math.min(60,this.currentDay+1)),console.log(`Time step changed: ${t}:${e} -> ${this.currentDay}:${this.currentTimeStep}`),this.requestRlPrediction()},toggleAutoplay(){this.autoPlayTimer&&(clearInterval(this.autoPlayTimer),this.autoPlayTimer=null),this.autoPlayActive=!this.autoPlayActive,this.autoPlayActive?(this.simulationState="ai",this.socket&&this.socket.emit("set_simulation_mode",{mode:"ai",interval:this.simulationInterval}),this.autoPlayTimer=setInterval(()=>{this.currentTimeStep=(this.currentTimeStep+1)%96,this.currentTimeStep===0&&(this.currentDay=Math.min(60,this.currentDay+1)),this.requestRlPrediction(),this.currentTimeStep%10===0&&this.optimizeMemoryUsage()},this.simulationInterval)):this.socket&&this.socket.emit("set_simulation_mode",{mode:"none"})},requestRlPrediction(){var t,e,i,a,r,o,n,l,s,h,p,u,d,m,T,C,_,H,L,I,b,E,M,O,x,V,B,P,R,Y,z,D,y,k,X,j,K,J,ot,nt,lt,ht,ct,ut,pt,dt,mt,ft,yt,gt,wt,St,vt,Ct,Tt,bt,At,_t,xt,Et;if(this.socket)try{this.simulationState="ai",console.log(`Requesting RL prediction for day ${this.currentDay}, step ${this.currentTimeStep}`);const et=setTimeout(()=>{console.warn("RL prediction request timed out")},5e3);if(!this.rlPrediction){const Ot={day:this.currentDay,timeStep:this.currentTimeStep,shift_prog:[0,0,0],time_to_start_shift:[0,0,0],home_temp:4,water_temp:-5,soc_ess:0,soc_ev:0,time_to_start_noctrl:[0,0,0,0,0]};this.socket.emit("request_rl_prediction",Ot);return}const It={day:this.currentDay,timeStep:this.currentTimeStep,shift_prog:[((a=(i=(e=(t=this.rlPrediction)==null?void 0:t.appliances)==null?void 0:e.shiftable)==null?void 0:i.dishwasher)==null?void 0:a.progress)||0,((l=(n=(o=(r=this.rlPrediction)==null?void 0:r.appliances)==null?void 0:o.shiftable)==null?void 0:n.wash_machine)==null?void 0:l.progress)||0,((u=(p=(h=(s=this.rlPrediction)==null?void 0:s.appliances)==null?void 0:h.shiftable)==null?void 0:p.clothes_dryer)==null?void 0:u.progress)||0],time_to_start_shift:[(C=(T=(m=(d=this.rlPrediction)==null?void 0:d.appliances)==null?void 0:m.shiftable)==null?void 0:T.dishwasher)!=null&&C.active?1:0,(I=(L=(H=(_=this.rlPrediction)==null?void 0:_.appliances)==null?void 0:H.shiftable)==null?void 0:L.wash_machine)!=null&&I.active?1:0,(O=(M=(E=(b=this.rlPrediction)==null?void 0:b.appliances)==null?void 0:E.shiftable)==null?void 0:M.clothes_dryer)!=null&&O.active?1:0],home_temp:(((B=(V=(x=this.rlPrediction)==null?void 0:x.temperatures)==null?void 0:V.home)==null?void 0:B.current)||26)-(((Y=(R=(P=this.rlPrediction)==null?void 0:P.temperatures)==null?void 0:R.home)==null?void 0:Y.setpoint)||22),water_temp:(((y=(D=(z=this.rlPrediction)==null?void 0:z.temperatures)==null?void 0:D.water)==null?void 0:y.current)||55)-(((j=(X=(k=this.rlPrediction)==null?void 0:k.temperatures)==null?void 0:X.water)==null?void 0:j.setpoint)||60),soc_ess:((J=(K=this.rlPrediction)==null?void 0:K.battery)==null?void 0:J.soc)||0,soc_ev:((nt=(ot=this.rlPrediction)==null?void 0:ot.ev)==null?void 0:nt.soc)||0,time_to_start_noctrl:[(ut=(ct=(ht=(lt=this.rlPrediction)==null?void 0:lt.appliances)==null?void 0:ht.fixed)==null?void 0:ct.tv)!=null&&ut.active?1:0,(ft=(mt=(dt=(pt=this.rlPrediction)==null?void 0:pt.appliances)==null?void 0:dt.fixed)==null?void 0:mt.refrigerator)!=null&&ft.active?1:0,(St=(wt=(gt=(yt=this.rlPrediction)==null?void 0:yt.appliances)==null?void 0:gt.fixed)==null?void 0:wt.lights)!=null&&St.active?1:0,(bt=(Tt=(Ct=(vt=this.rlPrediction)==null?void 0:vt.appliances)==null?void 0:Ct.fixed)==null?void 0:Tt.vacuum)!=null&&bt.active?1:0,(Et=(xt=(_t=(At=this.rlPrediction)==null?void 0:At.appliances)==null?void 0:_t.fixed)==null?void 0:xt.hair_dryer)!=null&&Et.active?1:0]};this.socket.emit("request_rl_prediction",It),this.socket.once("rl_prediction",()=>{clearTimeout(et)})}catch(et){console.error("Error requesting RL prediction:",et)}else console.warn("Socket not available for RL prediction request")},showTimeLimitNotification(t){const e=Math.floor(t.timeLimit/60),i=Math.floor(t.timeLimit%60);let a="";e>0&&(a+=`${e} hour${e>1?"s":""} `),i>0&&(a+=`${i} minute${i>1?"s":""} `),this.showAlert(`Simulation complete! Time limit of ${a} reached.`)},resetChartData(){if(!(!this.chart||!this.isChartInitialized))try{this.dataCache={};for(const t in this.shiftableAppliances)this.dataCache[t]=new Array(this.maxDataPoints).fill(0);if(this.chart.data&&this.chart.data.datasets){let t=0;for(const e in this.shiftableAppliances)t<this.chart.data.datasets.length&&(this.chart.data.datasets[t].data=[...this.dataCache[e]],t++);this.chart.update("none")}}catch(t){console.warn("Error resetting appliance chart data:",t.message)}}},watch:{simulationState(t,e){this.showRlControls=!0},timeStep(t){if(t===0){let e=!0;for(const i in this.powerHistory)if(this.powerHistory[i].some(a=>a>0)){e=!1;break}e&&this.resetChartData()}this.updateChart()}},computed:{canGoBack(){return!(this.currentDay===1&&this.currentTimeStep===0)},showStartButton(){return console.log(`Computing showStartButton: simulationState=${this.simulationState}`),this.simulationState==="idle"},showPauseButton(){return console.log(`Computing showPauseButton: isRunning=${this.isRunning}, simulationState=${this.simulationState}`),this.isRunning&&this.simulationState!=="idle"},showResumeButton(){return console.log(`Computing showResumeButton: isRunning=${this.isRunning}, simulationState=${this.simulationState}`),!this.isRunning&&this.simulationState!=="idle"},showResetButton(){return console.log(`Computing showResetButton: simulationState=${this.simulationState}`),this.simulationState!=="idle"},formattedTimeStep(){return this.formatTime(this.currentTimeStep)},formattedStepDisplay(){return`${this.currentTimeStep+1}/96`}},beforeUnmount(){window.ChartManager&&window.ChartManager.resetAllCharts(),this.autoPlayTimer&&(clearInterval(this.autoPlayTimer),this.autoPlayTimer=null),this.socket&&(this.socket.removeAllListeners(),this.socket.disconnect(),this.socket=null),this.rlPrediction=null,this.homeTemperatureHistory=null,this.waterTemperatureHistory=null,this.appliancePowerHistory=null}},Qe={class:"container"},ti={class:"main-layout"},ei={class:"diagram-section"},ii={key:0,class:"rl-simulation-controls"},ri={class:"rl-simulation-info"},ai={class:"rl-step-display"},si={class:"rl-step-value"},oi={class:"rl-step-display"},ni={class:"rl-step-value"},li={class:"rl-step-display"},hi={class:"rl-step-value"},ci={class:"rl-step-buttons"},ui=["disabled"],pi=["disabled"];function di(t,e,i,a,r,o){const n=at("energy-flow-diagram");return f(),g("div",Qe,[e[10]||(e[10]=c("header",null,[c("h1",null,"Smart Home Energy Simulator")],-1)),c("div",ti,[c("div",ei,[Ft(n,{"solar-output":r.solarOutput,"battery-level":r.batteryLevel,"battery-status":r.batteryStatus,"battery-power":r.batteryPower,"grid-power":r.gridPower,"house-demand":r.houseDemand,appliances:r.appliances,"is-running":r.simulationRunning,"simulation-state":r.simulationState,"rl-prediction":r.rlPrediction,"simulation-elapsed-minutes":r.simulationElapsedMinutes,"simulation-formatted-time":r.simulationFormattedTime,"simulation-day":r.simulationDay,"home-temperature-history":r.homeTemperatureHistory,"water-temperature-history":r.waterTemperatureHistory,"appliance-power-history":r.appliancePowerHistory,"simulation-completed":r.simulationCompleted,onStartSimulation:o.startSimulation,onPauseSimulation:o.pauseSimulation,onResumeSimulation:o.resumeSimulation,onResetSimulation:o.resetSimulation,onToggleAppliance:o.toggleAppliance,onDemandUpdated:o.updateHouseDemand,onGridPowerUpdated:o.updateGridPower,onConfigUpdated:o.handleConfigUpdated,onSpeedChanged:o.handleSpeedChange,onBatteryCritical:o.handleBatteryCritical,onHistoryUpdated:o.onHistoryUpdated,onHourlyDataUpdate:o.handleHourlyDataUpdate,onSimulationComplete:o.handleSimulationComplete,onEnergyModelsUpdated:o.handleEnergyModelsUpdate,onSolarOutputUpdated:e[0]||(e[0]=l=>r.solarOutput=l),onBatteryLevelUpdated:e[1]||(e[1]=l=>r.batteryLevel=l),onBatteryStatusUpdated:e[2]||(e[2]=l=>r.batteryStatus=l),onUpdateAppliancePower:o.handleAppliancePowerUpdate},null,8,["solar-output","battery-level","battery-status","battery-power","grid-power","house-demand","appliances","is-running","simulation-state","rl-prediction","simulation-elapsed-minutes","simulation-formatted-time","simulation-day","home-temperature-history","water-temperature-history","appliance-power-history","simulation-completed","onStartSimulation","onPauseSimulation","onResumeSimulation","onResetSimulation","onToggleAppliance","onDemandUpdated","onGridPowerUpdated","onConfigUpdated","onSpeedChanged","onBatteryCritical","onHistoryUpdated","onHourlyDataUpdate","onSimulationComplete","onEnergyModelsUpdated","onUpdateAppliancePower"])])]),r.showRlControls?(f(),g("div",ii,[e[9]||(e[9]=c("h3",null,"AI Optimization Simulation",-1)),c("div",ri,[c("div",ai,[e[6]||(e[6]=c("div",{class:"rl-step-label"},"Day:",-1)),c("div",si,v(r.currentDay),1)]),c("div",oi,[e[7]||(e[7]=c("div",{class:"rl-step-label"},"Time:",-1)),c("div",ni,v(o.formattedTimeStep),1)]),c("div",li,[e[8]||(e[8]=c("div",{class:"rl-step-label"},"Step:",-1)),c("div",hi,v(o.formattedStepDisplay),1)])]),c("div",ci,[c("button",{onClick:e[3]||(e[3]=(...l)=>o.previousStep&&o.previousStep(...l)),class:"rl-btn rl-prev-btn",disabled:!o.canGoBack||r.autoPlayActive}," Previous ",8,ui),c("button",{onClick:e[4]||(e[4]=(...l)=>o.nextStep&&o.nextStep(...l)),class:"rl-btn rl-next-btn",disabled:r.autoPlayActive}," Next ",8,pi),c("button",{onClick:e[5]||(e[5]=(...l)=>o.toggleAutoplay&&o.toggleAutoplay(...l)),class:N(["rl-btn",{"rl-pause-btn":r.autoPlayActive,"rl-play-btn":!r.autoPlayActive}])},v(r.autoPlayActive?"Pause":"Auto Play"),3)])])):F("",!0)])}const mi=tt(Ze,[["render",di]]);Gt();Nt(mi).mount("#app");
